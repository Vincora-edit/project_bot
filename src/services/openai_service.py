"""
–°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å OpenAI GPT.

–í—Å–µ –≤—ã–∑–æ–≤—ã GPT —Å–æ–±—Ä–∞–Ω—ã –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ —Å –µ–¥–∏–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫.
"""

from openai import OpenAI

from src.config import settings
from src.config.settings import TONE_OF_VOICE
from src.utils.logging import get_logger


logger = get_logger(__name__)


class OpenAIService:
    """–°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å OpenAI API."""

    def __init__(self):
        self._client: OpenAI | None = None

    @property
    def client(self) -> OpenAI:
        """–õ–µ–Ω–∏–≤–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞."""
        if self._client is None:
            self._client = OpenAI(api_key=settings.openai_api_key)
        return self._client

    def _call_gpt(
        self,
        system_prompt: str,
        user_content: str,
        max_tokens: int = 300,
        temperature: float = 0.7
    ) -> str:
        """
        –ë–∞–∑–æ–≤—ã–π –≤—ã–∑–æ–≤ GPT.

        Args:
            system_prompt: –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç
            user_content: –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            max_tokens: –ú–∞–∫—Å–∏–º—É–º —Ç–æ–∫–µ–Ω–æ–≤ –≤ –æ—Ç–≤–µ—Ç–µ
            temperature: –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏

        Returns:
            str: –û—Ç–≤–µ—Ç GPT –∏–ª–∏ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ
        """
        try:
            response = self.client.chat.completions.create(
                model=settings.openai_model,
                messages=[
                    {"role": "system", "content": system_prompt},
                    {"role": "user", "content": user_content},
                ],
                max_tokens=max_tokens,
                temperature=temperature,
            )
            return (response.choices[0].message.content or "").strip()
        except Exception as e:
            logger.error(f"GPT call error: {e}")
            return ""

    async def check_if_need_answer(self, text: str, context: str = "") -> bool:
        """
        –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –Ω—É–∂–µ–Ω –ª–∏ –æ—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞.

        Args:
            text: –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
            context: –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

        Returns:
            bool: True –µ—Å–ª–∏ –Ω—É–∂–µ–Ω –æ—Ç–≤–µ—Ç
        """
        user_content = text or ""
        if context:
            user_content = f"–ö–æ–Ω—Ç–µ–∫—Å—Ç (–ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è):\n{context}\n\n–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞:\n{text}"

        system_prompt = (
            "–û–ø—Ä–µ–¥–µ–ª–∏, –Ω—É–∂–Ω–æ –ª–∏ –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –ù–û–í–û–ï —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞, —É—á–∏—Ç—ã–≤–∞—è –∫–æ–Ω—Ç–µ–∫—Å—Ç.\n"
            "–í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û 1 –∏–ª–∏ 0:\n"
            "1 ‚Äî –µ—Å–ª–∏ —ç—Ç–æ –≤–æ–ø—Ä–æ—Å/–ø—Ä–æ—Å—å–±–∞/–ø—Ä–æ–±–ª–µ–º–∞/–ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Ç–µ–º—ã\n"
            "0 ‚Äî –µ—Å–ª–∏ —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ '–æ–∫', '—Å–ø–∞—Å–∏–±–æ', —ç–º–æ–¥–∑–∏\n\n"
            "–í–ê–ñ–ù–û: –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –ø–∏—à–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–¥—Ä—è–¥ (—Ä–∞–∑–≤–∏–≤–∞—è –º—ã—Å–ª—å) - —ç—Ç–æ –û–î–ù–ê –ø—Ä–æ—Å—å–±–∞, "
            "–Ω—É–∂–µ–Ω –æ—Ç–≤–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ –ü–û–°–õ–ï–î–ù–ï–ï —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Ü–µ–ø–æ—á–∫–µ."
        )

        result = self._call_gpt(system_prompt, user_content, max_tokens=1)
        return result == "1"

    async def generate_suggestion_and_tasks(
        self,
        client_text: str,
        context: str = ""
    ) -> tuple[str, list[str]]:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –∏ —Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á.

        Args:
            client_text: –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞
            context: –ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞

        Returns:
            tuple[str, list[str]]: (–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç, —Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á)
        """
        user_content = client_text or ""
        if context:
            user_content = f"–ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞:\n{context}\n\n–ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞:\n{client_text}"

        system_prompt = (
            "–¢—ã –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø—Ä–æ–¥–∂–µ–∫—Ç–∞ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤–æ–≥–æ –∞–≥–µ–Ω—Ç—Å—Ç–≤–∞. "
            "–£—á–∏—Ç—ã–≤–∞–π –í–ï–°–¨ –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞.\n\n"
            f"–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ø–∏—à–∏ –≤ –Ω–∞—à–µ–º tone of voice:\n{TONE_OF_VOICE}\n\n"
            "–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π:\n"
            "1) REPLY ‚Äî –æ—Ç–≤–µ—Ç –∫–ª–∏–µ–Ω—Ç—É (1-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –∂–∏–≤–æ –∏ –ø–æ-–¥—Ä—É–∂–µ—Å–∫–∏)\n"
            "2) TASKS ‚Äî 3-5 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –∑–∞–¥–∞—á –¥–ª—è –∫–æ–º–∞–Ω–¥—ã\n\n"
            "–§–æ—Ä–º–∞—Ç:\n"
            "REPLY: <—Ç–µ–∫—Å—Ç>\n"
            "TASKS:\n"
            "- <–∑–∞–¥–∞—á–∞ 1>\n"
            "- <–∑–∞–¥–∞—á–∞ 2>"
        )

        text = self._call_gpt(system_prompt, user_content)

        # –ü–∞—Ä—Å–∏–º –æ—Ç–≤–µ—Ç
        reply = ""
        tasks: list[str] = []

        if "REPLY:" in text:
            part = text.split("REPLY:", 1)[1]
            if "TASKS:" in part:
                reply_part, tasks_part = part.split("TASKS:", 1)
                reply = reply_part.strip()
                for line in tasks_part.splitlines():
                    line = line.strip()
                    if line.startswith("-"):
                        tasks.append(line.lstrip("-").strip())
            else:
                reply = part.strip()

        # –§–æ–ª–±—ç–∫–∏
        if not reply:
            reply = "–°–ø–∞—Å–∏–±–æ –∑–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é! –ü—Ä–∏–Ω—è–ª, —Å–µ–π—á–∞—Å –æ–±—Ä–∞–±–æ—Ç–∞–µ–º –∏ –≤–µ—Ä–Ω—ë–º—Å—è."
        if not tasks:
            tasks = ["–û–±—Ä–∞–±–æ—Ç–∞—Ç—å –∑–∞–ø—Ä–æ—Å –∫–ª–∏–µ–Ω—Ç–∞", "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–µ—Ç–∞–ª–∏", "–í–µ—Ä–Ω—É—Ç—å—Å—è —Å –æ—Ç–≤–µ—Ç–æ–º"]

        return reply, tasks

    async def generate_response_variants(
        self,
        client_text: str,
        context: str = ""
    ) -> list[dict]:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–∞ –∫–ª–∏–µ–Ω—Ç—É.

        Args:
            client_text: –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞
            context: –ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞

        Returns:
            list[dict]: –°–ø–∏—Å–æ–∫ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ [{"tone": "...", "text": "..."}]
        """
        user_content = client_text or ""
        if context:
            user_content = f"–ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞:\n{context}\n\n–°–æ–æ–±—â–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞:\n{client_text}"

        system_prompt = (
            "–¢—ã –ø–æ–º–æ—â–Ω–∏–∫ –ø—Ä–æ–¥–∂–µ–∫—Ç-–º–µ–Ω–µ–¥–∂–µ—Ä–∞ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤–æ–≥–æ –∞–≥–µ–Ω—Ç—Å—Ç–≤–∞.\n\n"
            f"–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ø–∏—à–∏ –≤ –Ω–∞—à–µ–º tone of voice:\n{TONE_OF_VOICE}\n\n"
            "–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –≤–∞—Ä–∏–∞–Ω—Ç –æ—Ç–≤–µ—Ç–∞ –∫–ª–∏–µ–Ω—Ç—É.\n"
            "–û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω:\n"
            "- –û—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –∑–∞–ø—Ä–æ—Å –∫–ª–∏–µ–Ω—Ç–∞\n"
            "- –ë—ã—Ç—å –≥–æ—Ç–æ–≤—ã–º –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ (–±–µ–∑ –ø—Ä–∞–≤–æ–∫)\n"
            "- –ë—ã—Ç—å –∂–∏–≤—ã–º, –∫–∞–∫ —Ä–∞–∑–≥–æ–≤–æ—Ä —Å –¥—Ä—É–≥–æ–º\n"
            "- –°–æ–¥–µ—Ä–∂–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –∏–ª–∏ —Å—Ä–æ–∫–∏ –µ—Å–ª–∏ —É–º–µ—Å—Ç–Ω–æ\n\n"
            "–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:\n"
            "–î–†–£–ñ–ï–õ–Æ–ë–ù–´–ô:\n<—Ç–µ–∫—Å—Ç>\n\n"
        )

        text = self._call_gpt(system_prompt, user_content, max_tokens=500)

        # –ü–∞—Ä—Å–∏–º
        variants = []
        if "–î–†–£–ñ–ï–õ–Æ–ë–ù–´–ô:" in text:
            variant_text = text.split("–î–†–£–ñ–ï–õ–Æ–ë–ù–´–ô:", 1)[1].strip()
            if variant_text:
                variants.append({"tone": "–î—Ä—É–∂–µ–ª—é–±–Ω—ã–π", "text": variant_text})

        # –§–æ–ª–±—ç–∫
        if not variants:
            variants = [
                {"tone": "–î—Ä—É–∂–µ–ª—é–±–Ω—ã–π", "text": "–ü—Ä–∏–≤–µ—Ç! –°–ø–∞—Å–∏–±–æ —á—Ç–æ –Ω–∞–ø–∏—Å–∞–ª, —É–∂–µ —Ä–∞–±–æ—Ç–∞—é –Ω–∞–¥ —ç—Ç–∏–º üòä"}
            ]

        return variants

    async def generate_holiday_greeting(
        self,
        holiday_name: str,
        chat_name: str
    ) -> str:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ —Å –ø—Ä–∞–∑–¥–Ω–∏–∫–æ–º.

        Args:
            holiday_name: –ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∞–∑–¥–Ω–∏–∫–∞
            chat_name: –ù–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞ (–¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Å—Ñ–µ—Ä—ã –∫–ª–∏–µ–Ω—Ç–∞)

        Returns:
            str: –¢–µ–∫—Å—Ç –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è
        """
        system_prompt = (
            "–¢—ã –ø–æ–º–æ—â–Ω–∏–∫ –ø—Ä–æ–¥–∂–µ–∫—Ç-–º–µ–Ω–µ–¥–∂–µ—Ä–∞ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤–æ–≥–æ –∞–≥–µ–Ω—Ç—Å—Ç–≤–∞.\n"
            "–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –∫–æ—Ä–æ—Ç–∫–æ–µ (2-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è) —Ç—ë–ø–ª–æ–µ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ —Å –ø—Ä–∞–∑–¥–Ω–∏–∫–æ–º.\n\n"
            f"–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ø–∏—à–∏ –≤ –Ω–∞—à–µ–º tone of voice:\n{TONE_OF_VOICE}\n\n"
            "–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:\n"
            "- –£–ø–æ–º—è–Ω–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∞–∑–¥–Ω–∏–∫–∞\n"
            "- –ï—Å–ª–∏ –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è —á–∞—Ç–∞ –ø–æ–Ω—è—Ç–Ω–∞ —Å—Ñ–µ—Ä–∞ –∫–ª–∏–µ–Ω—Ç–∞ ‚Äî –¥–æ–±–∞–≤—å –ø–æ–∂–µ–ª–∞–Ω–∏–µ –ø—Ä–æ –µ–≥–æ –±–∏–∑–Ω–µ—Å\n"
            "- –ü–∏—à–∏ –∫–∞–∫ –¥—Ä—É–≥—É, –Ω–æ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ\n"
            "- –ú–æ–∂–Ω–æ 1-2 —ç–º–æ–¥–∑–∏\n"
            "- –ù–ï –Ω–∞—á–∏–Ω–∞–π —Å '–£–≤–∞–∂–∞–µ–º—ã–π' ‚Äî —ç—Ç–æ —Ñ–æ—Ä–º–∞–ª—å–Ω–æ\n"
        )

        user_content = f"–ü—Ä–∞–∑–¥–Ω–∏–∫: {holiday_name}\n–ö–ª–∏–µ–Ω—Ç/—á–∞—Ç: {chat_name}"

        result = self._call_gpt(system_prompt, user_content, max_tokens=200)

        if not result:
            result = f"üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º —Å –ø—Ä–∞–∑–¥–Ω–∏–∫–æ–º ‚Äî {holiday_name}! –ñ–µ–ª–∞–µ–º —É—Å–ø–µ—Ö–æ–≤, –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏—è –∏ –æ—Ç–ª–∏—á–Ω–æ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è!"

        return result

    async def generate_stage_message(
        self,
        prompt: str,
        deal: dict,
        chat_history: str,
        template: str = ""
    ) -> str:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —Å—Ç–∞–¥–∏–∏ —Å–¥–µ–ª–∫–∏.

        Args:
            prompt: –ü—Ä–æ–º–ø—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
            deal: –î–∞–Ω–Ω—ã–µ —Å–¥–µ–ª–∫–∏
            chat_history: –ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞
            template: –ë–∞–∑–æ–≤—ã–π —à–∞–±–ª–æ–Ω (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

        Returns:
            str: –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        """
        context = f"""
## –î–∞–Ω–Ω—ã–µ –æ —Å–¥–µ–ª–∫–µ
- –ù–∞–∑–≤–∞–Ω–∏–µ: {deal.get('deal_name', '–ù–µ —É–∫–∞–∑–∞–Ω–æ')}
- –£—Å–ª—É–≥–∞: {deal.get('service_type', 'geo')}
- ID —Å–¥–µ–ª–∫–∏: {deal.get('deal_id', '')}

## –ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–ø–∏—Å–∫–∏ —Å –∫–ª–∏–µ–Ω—Ç–æ–º (–ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è)
{chat_history}

## –ë–∞–∑–æ–≤—ã–π —à–∞–±–ª–æ–Ω —Å–æ–æ–±—â–µ–Ω–∏—è (–∏—Å–ø–æ–ª—å–∑—É–π –∫–∞–∫ –æ—Å–Ω–æ–≤—É, –Ω–æ –∞–¥–∞–ø—Ç–∏—Ä—É–π)
{template if template else '–®–∞–±–ª–æ–Ω –Ω–µ —É–∫–∞–∑–∞–Ω ‚Äî —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –Ω—É–ª—è'}
"""

        system_prompt = f"""{TONE_OF_VOICE}

## –¢–≤–æ—è –∑–∞–¥–∞—á–∞
{prompt}

## –í–∞–∂–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞
1. –ü–∏—à–∏ –æ—Ç –ª–∏—Ü–∞ –ø—Ä–æ–¥–∂–µ–∫—Ç-–º–µ–Ω–µ–¥–∂–µ—Ä–∞ –∞–≥–µ–Ω—Ç—Å—Ç–≤–∞
2. –£—á–∏—Ç—ã–≤–∞–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–µ—Ä–µ–ø–∏—Å–∫–∏ ‚Äî –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —á—Ç–æ-—Ç–æ –æ–±—Å—É–∂–¥–∞–ª, –º–æ–∂–Ω–æ —ç—Ç–æ —É–ø–æ–º—è–Ω—É—Ç—å
3. –°–æ–æ–±—â–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –∫–æ—Ä–æ—Ç–∫–∏–º (2-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
4. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Ñ–æ—Ä–º–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞—â–µ–Ω–∏—è —Ç–∏–ø–∞ "–£–≤–∞–∂–∞–µ–º—ã–π"
5. –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å 1-2 —ç–º–æ–¥–∑–∏, –Ω–æ –Ω–µ –ø–µ—Ä–µ–±–∞—Ä—â–∏–≤–∞–π
6. –ï—Å–ª–∏ –≤ –∏—Å—Ç–æ—Ä–∏–∏ –≤–∏–¥–Ω–æ –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞ ‚Äî –º–æ–∂–µ—à—å –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –ø–æ –∏–º–µ–Ω–∏
"""

        return self._call_gpt(system_prompt, context, max_tokens=300)

    async def generate_upsell_suggestion(
        self,
        deal: dict,
        chat_history: str
    ) -> str:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ø—Ä–æ–¥–∞–∂–∏.

        Args:
            deal: –î–∞–Ω–Ω—ã–µ —Å–¥–µ–ª–∫–∏
            chat_history: –ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞

        Returns:
            str: –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ø—Ä–æ–¥–∞–∂–∏
        """
        services = """
–ù–∞—à–∏ —É—Å–ª—É–≥–∏:
1. –ì–µ–æ–º–∞—Ä–∫–µ—Ç–∏–Ω–≥ - –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ –Ω–∞ –∫–∞—Ä—Ç–∞—Ö (–Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç—ã, 2–ì–ò–°, Google Maps), —Ä–∞–±–æ—Ç–∞ —Å –æ—Ç–∑—ã–≤–∞–º–∏, –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫
2. –°–∞–π—Ç—ã - —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –∏ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ —Å–∞–π—Ç–æ–≤, SEO-–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
3. –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–∞—è —Ä–µ–∫–ª–∞–º–∞ - –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –∏ –≤–µ–¥–µ–Ω–∏–µ —Ä–µ–∫–ª–∞–º—ã –≤ –Ø–Ω–¥–µ–∫—Å –î–∏—Ä–µ–∫—Ç, Google Ads
4. –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è - —á–∞—Ç-–±–æ—Ç—ã, CRM-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏, –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤
"""

        prompt = f"""–¢—ã - –æ–ø—ã—Ç–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç-–º–µ–Ω–µ–¥–∂–µ—Ä. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∫–ª–∏–µ–Ω—Ç–∞ –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –¥–æ–ø—Ä–æ–¥–∞–∂—É.

{services}

–¢–µ–∫—É—â–∞—è —É—Å–ª—É–≥–∞ –∫–ª–∏–µ–Ω—Ç–∞: {deal.get('service_type', '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')}
–ù–∞–∑–≤–∞–Ω–∏–µ —Å–¥–µ–ª–∫–∏: {deal.get('deal_name', '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')}

–ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–ø–∏—Å–∫–∏ —Å –∫–ª–∏–µ–Ω—Ç–æ–º:
{chat_history}

–ó–∞–¥–∞—á–∞:
1. –û–ø—Ä–µ–¥–µ–ª–∏ –∫–∞–∫—É—é –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é —É—Å–ª—É–≥—É –º–æ–∂–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å —ç—Ç–æ–º—É –∫–ª–∏–µ–Ω—Ç—É
2. –ù–∞–ø–∏—à–∏ –∫–æ—Ä–æ—Ç–∫–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ –ø–æ—á–µ–º—É –∏–º–µ–Ω–Ω–æ —ç—Ç–∞ —É—Å–ª—É–≥–∞ –ø–æ–¥–æ–π–¥—ë—Ç
3. –ù–∞–ø–∏—à–∏ –≥–æ—Ç–æ–≤–æ–µ –ø—Ä–æ–¥–∞—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ (3-5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π, –Ω–∞ "–í—ã", –∂–∏–≤–æ–π —Å—Ç–∏–ª—å)

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:
–£–°–õ–£–ì–ê: [–Ω–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏]
–ü–û–ß–ï–ú–£: [–æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ –≤ 1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è]
–°–û–û–ë–©–ï–ù–ò–ï:
[–≥–æ—Ç–æ–≤—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–ª–∏–µ–Ω—Ç—É]"""

        return self._call_gpt(
            "–¢—ã –æ–ø—ã—Ç–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç-–º–µ–Ω–µ–¥–∂–µ—Ä –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤–æ–≥–æ –∞–≥–µ–Ω—Ç—Å—Ç–≤–∞.",
            prompt,
            max_tokens=500
        )

    async def generate_digest(
        self,
        messages: list[dict],
        client_info: dict | None = None,
        period: str = "–∑–∞ –ø–µ—Ä–∏–æ–¥"
    ) -> str:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –¥–∞–π–¥–∂–µ—Å—Ç –ø–æ –ø–µ—Ä–µ–ø–∏—Å–∫–µ —Å –∫–ª–∏–µ–Ω—Ç–æ–º.

        Args:
            messages: –°–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π [{from_name, text, is_project, timestamp}]
            client_info: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
            period: –û–ø–∏—Å–∞–Ω–∏–µ –ø–µ—Ä–∏–æ–¥–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä "–∑–∞ –Ω–µ–¥–µ–ª—é")

        Returns:
            str: –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–∞–π–¥–∂–µ—Å—Ç
        """
        if not messages:
            return "üì≠ –ó–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ."

        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
        conversation = []
        for msg in messages:
            sender = "üë§ –ö–ª–∏–µ–Ω—Ç" if not msg.get("is_project") else "üíº –ü—Ä–æ–¥–∂–µ–∫—Ç"
            text = msg.get("text", "")[:500]  # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É
            conversation.append(f"{sender}: {text}")

        conversation_text = "\n".join(conversation[-100:])  # –ü–æ—Å–ª–µ–¥–Ω–∏–µ 100 —Å–æ–æ–±—â–µ–Ω–∏–π

        # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–ª–∏–µ–Ω—Ç–µ
        client_context = ""
        if client_info:
            fields = []
            if client_info.get("client_name"):
                fields.append(f"–ö–ª–∏–µ–Ω—Ç: {client_info['client_name']}")
            if client_info.get("decision_maker"):
                fields.append(f"–õ–ü–†: {client_info['decision_maker']}")
            if client_info.get("service_type"):
                fields.append(f"–£—Å–ª—É–≥–∞: {client_info['service_type']}")
            if client_info.get("preferences"):
                fields.append(f"–õ—é–±–∏—Ç: {client_info['preferences']}")
            if client_info.get("dislikes"):
                fields.append(f"–ù–µ –ª—é–±–∏—Ç: {client_info['dislikes']}")
            if fields:
                client_context = "## –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ\n" + "\n".join(fields) + "\n\n"

        system_prompt = f"""–¢—ã –∞–Ω–∞–ª–∏—Ç–∏–∫ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤–æ–≥–æ –∞–≥–µ–Ω—Ç—Å—Ç–≤–∞. –°–æ—Å—Ç–∞–≤—å –∫—Ä–∞—Ç–∫–∏–π –¥–∞–π–¥–∂–µ—Å—Ç –ø–µ—Ä–µ–ø–∏—Å–∫–∏ —Å –∫–ª–∏–µ–Ω—Ç–æ–º {period}.

{client_context}## –§–æ—Ä–º–∞—Ç –¥–∞–π–¥–∂–µ—Å—Ç–∞
–û—Ç–≤–µ—Ç –°–¢–†–û–ì–û –≤ —Ç–∞–∫–æ–º —Ñ–æ—Ä–º–∞—Ç–µ:

üìä –°–¢–ê–¢–£–°: [–û–±—â–µ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞: –¥–æ–≤–æ–ª–µ–Ω/–Ω–µ–π—Ç—Ä–∞–ª–µ–Ω/–µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã/–Ω–µ–¥–æ–≤–æ–ª–µ–Ω]

üîë –ö–õ–Æ–ß–ï–í–´–ï –¢–ï–ú–´:
‚Ä¢ [—Ç–µ–º–∞ 1]
‚Ä¢ [—Ç–µ–º–∞ 2]
‚Ä¢ [—Ç–µ–º–∞ 3]

‚ö†Ô∏è –ü–†–û–ë–õ–ï–ú–´/–ó–ê–ü–†–û–°–´:
‚Ä¢ [–µ—Å–ª–∏ –±—ã–ª–∏ ‚Äî –ø–µ—Ä–µ—á–∏—Å–ª–∏, –µ—Å–ª–∏ –Ω–µ—Ç ‚Äî "–ù–µ—Ç –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø—Ä–æ–±–ª–µ–º"]

‚úÖ –í–´–ü–û–õ–ù–ï–ù–û:
‚Ä¢ [—á—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ –∫–æ–º–∞–Ω–¥–æ–π]

üìã –ù–£–ñ–ù–û –°–î–ï–õ–ê–¢–¨:
‚Ä¢ [—á—Ç–æ –æ—Å—Ç–∞–ª–æ—Å—å —Å–¥–µ–ª–∞—Ç—å –∏–ª–∏ –Ω–∞ —á—Ç–æ –æ–±—Ä–∞—Ç–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ]

üí° –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:
‚Ä¢ [1-2 —Å–æ–≤–µ—Ç–∞ –¥–ª—è –ø—Ä–æ–¥–∂–µ–∫—Ç–∞]

## –ü—Ä–∞–≤–∏–ª–∞
- –ü–∏—à–∏ –∫—Ä–∞—Ç–∫–æ, –ø–æ –¥–µ–ª—É
- –í—ã–¥–µ–ª—è–π –≥–ª–∞–≤–Ω–æ–µ
- –ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –º–∞–ª–æ ‚Äî –ø–∏—à–∏ "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö"
- –ù–µ –≤—ã–¥—É–º—ã–≤–∞–π —Ç–æ, —á–µ–≥–æ –Ω–µ—Ç –≤ –ø–µ—Ä–µ–ø–∏—Å–∫–µ"""

        result = self._call_gpt(system_prompt, conversation_text, max_tokens=800, temperature=0.5)

        if not result:
            result = "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–∞–π–¥–∂–µ—Å—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."

        return result

    async def extract_commitment(
        self,
        message_text: str,
        context: str = ""
    ) -> dict | None:
        """
        –ò–∑–≤–ª–µ–∫–∞–µ—Ç –¥–æ–≥–æ–≤–æ—Ä—ë–Ω–Ω–æ—Å—Ç—å/–æ–±–µ—â–∞–Ω–∏–µ –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–æ–¥–∂–µ–∫—Ç–∞.

        Args:
            message_text: –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–æ–¥–∂–µ–∫—Ç–∞
            context: –ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞

        Returns:
            dict | None: {
                "has_commitment": bool,
                "text": str,  # –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–æ–≥–æ–≤–æ—Ä—ë–Ω–Ω–æ—Å—Ç–∏
                "remind_in_hours": int  # –ß–µ—Ä–µ–∑ —Å–∫–æ–ª—å–∫–æ —á–∞—Å–æ–≤ –Ω–∞–ø–æ–º–Ω–∏—Ç—å
            }
        """
        user_content = message_text
        if context:
            user_content = f"–ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞:\n{context}\n\n–°–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–æ–¥–∂–µ–∫—Ç–∞:\n{message_text}"

        system_prompt = """–¢—ã –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—à—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–æ–¥–∂–µ–∫—Ç-–º–µ–Ω–µ–¥–∂–µ—Ä–∞ –∫–ª–∏–µ–Ω—Ç—É.
–û–ø—Ä–µ–¥–µ–ª–∏, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–±–µ—â–∞–Ω–∏–µ/–¥–æ–≥–æ–≤–æ—Ä—ë–Ω–Ω–æ—Å—Ç—å, –æ –∫–æ—Ç–æ—Ä–æ–π –Ω—É–∂–Ω–æ –Ω–∞–ø–æ–º–Ω–∏—Ç—å.

–ü—Ä–∏–º–µ—Ä—ã –æ–±–µ—â–∞–Ω–∏–π:
- "–ó–∞–≤—Ç—Ä–∞ –ø—Ä–∏—à–ª—é –æ—Ç—á—ë—Ç" ‚Üí –¥–∞, –Ω–∞–ø–æ–º–Ω–∏—Ç—å —á–µ—Ä–µ–∑ 20 —á–∞—Å–æ–≤
- "–°–æ–∑–≤–æ–Ω–∏–º—Å—è –≤ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫" ‚Üí –¥–∞, –Ω–∞–ø–æ–º–Ω–∏—Ç—å –∑–∞ 2 —á–∞—Å–∞ –¥–æ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫–∞
- "–°–¥–µ–ª–∞—é –Ω–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ" ‚Üí –¥–∞, –Ω–∞–ø–æ–º–Ω–∏—Ç—å —á–µ—Ä–µ–∑ 3 –¥–Ω—è
- "–£—Ç–æ—á–Ω—é —É –∫–æ–º–∞–Ω–¥—ã –∏ –≤–µ—Ä–Ω—É—Å—å" ‚Üí –¥–∞, –Ω–∞–ø–æ–º–Ω–∏—Ç—å —á–µ—Ä–µ–∑ 4 —á–∞—Å–∞
- "–ü–æ—Å–º–æ—Ç—Ä—é —Å–µ–≥–æ–¥–Ω—è" ‚Üí –¥–∞, –Ω–∞–ø–æ–º–Ω–∏—Ç—å —á–µ—Ä–µ–∑ 6 —á–∞—Å–æ–≤
- "–û–∫, –ø—Ä–∏–Ω—è–ª" ‚Üí –Ω–µ—Ç, —ç—Ç–æ –Ω–µ –æ–±–µ—â–∞–Ω–∏–µ
- "–°–ø–∞—Å–∏–±–æ –∑–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é" ‚Üí –Ω–µ—Ç
- "–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ –¥–µ–ª–∞?" ‚Üí –Ω–µ—Ç

–û—Ç–≤–µ—Ç—å –°–¢–†–û–ì–û –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON:
{"has_commitment": true/false, "text": "–∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ", "remind_in_hours": —á–∏—Å–ª–æ}

–ï—Å–ª–∏ –æ–±–µ—â–∞–Ω–∏—è –Ω–µ—Ç, –≤–µ—Ä–Ω–∏:
{"has_commitment": false, "text": "", "remind_in_hours": 0}

–í–∞–∂–Ω–æ:
- remind_in_hours –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ä–∞–∑—É–º–Ω—ã–º (1-168 —á–∞—Å–æ–≤, —Ç–æ –µ—Å—Ç—å –¥–æ –Ω–µ–¥–µ–ª–∏)
- –£—á–∏—Ç—ã–≤–∞–π —Ç–µ–∫—É—â–∏–π –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏ –¥–ª—è "–≤ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫", "–∑–∞–≤—Ç—Ä–∞" –∏ —Ç.–ø.
- –î–ª—è –Ω–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö —Å—Ä–æ–∫–æ–≤ ("—Å–∫–æ—Ä–æ", "–Ω–∞ –¥–Ω—è—Ö") —Å—Ç–∞–≤—å 24-48 —á–∞—Å–æ–≤"""

        result = self._call_gpt(system_prompt, user_content, max_tokens=100, temperature=0.3)

        if not result:
            return None

        # –ü–∞—Ä—Å–∏–º JSON
        try:
            import json
            # –û—á–∏—â–∞–µ–º –æ—Ç –≤–æ–∑–º–æ–∂–Ω—ã—Ö markdown-–æ–±—ë—Ä—Ç–æ–∫
            result = result.strip()
            if result.startswith("```"):
                result = result.split("```")[1]
                if result.startswith("json"):
                    result = result[4:]
            result = result.strip()

            data = json.loads(result)
            if data.get("has_commitment"):
                return data
            return None
        except Exception as e:
            logger.error(f"Error parsing commitment: {e}, result: {result}")
            return None

    async def extract_client_info_from_history(
        self,
        messages: list[dict],
        chat_name: str
    ) -> dict:
        """
        –ò–∑–≤–ª–µ–∫–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–ª–∏–µ–Ω—Ç–µ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ –ø–µ—Ä–µ–ø–∏—Å–∫–∏.

        Args:
            messages: –°–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
            chat_name: –ù–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞

        Returns:
            dict —Å –ø–æ–ª—è–º–∏: client_name, decision_maker, contact_person,
                          preferences, dislikes, communication_style, service_type
        """
        if not messages:
            return {}

        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
        conversation = []
        for msg in messages[-150:]:  # –ü–æ—Å–ª–µ–¥–Ω–∏–µ 150 —Å–æ–æ–±—â–µ–Ω–∏–π
            sender = "–ö–ª–∏–µ–Ω—Ç" if not msg.get("is_project") else "–ü—Ä–æ–¥–∂–µ–∫—Ç"
            text = msg.get("text", "")[:300]
            conversation.append(f"{sender}: {text}")

        conversation_text = "\n".join(conversation)

        system_prompt = f"""–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø–µ—Ä–µ–ø–∏—Å–∫—É —Å –∫–ª–∏–µ–Ω—Ç–æ–º –∏ –∏–∑–≤–ª–µ–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.
–ù–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞: {chat_name}

–í–µ—Ä–Ω–∏ JSON —Å–æ —Å–ª–µ–¥—É—é—â–∏–º–∏ –ø–æ–ª—è–º–∏ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ø–í–ù–û –µ—Å—Ç—å –≤ –ø–µ—Ä–µ–ø–∏—Å–∫–µ):

{{
  "client_name": "–Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏/–ø—Ä–æ–µ–∫—Ç–∞ –∫–ª–∏–µ–Ω—Ç–∞",
  "decision_maker": "–õ–ü–† - –∫—Ç–æ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ä–µ—à–µ–Ω–∏—è (–∏–º—è, –¥–æ–ª–∂–Ω–æ—Å—Ç—å)",
  "contact_person": "–∫–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ –ª–∏—Ü–æ, —Å –∫–µ–º –æ–±—â–∞–µ–º—Å—è (–∏–º—è)",
  "preferences": "—á—Ç–æ –∫–ª–∏–µ–Ω—Ç—É –Ω—Ä–∞–≤–∏—Ç—Å—è, –≤–∞–∂–Ω–æ (–∫—Ä–∞—Ç–∫–æ)",
  "dislikes": "—á—Ç–æ –Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è, —Ä–∞–∑–¥—Ä–∞–∂–∞–µ—Ç (–∫—Ä–∞—Ç–∫–æ)",
  "communication_style": "—Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π/–¥—Ä—É–∂–µ—Å–∫–∏–π/–¥–µ–ª–æ–≤–æ–π",
  "service_type": "—Ç–∏–ø —É—Å–ª—É–≥–∏: geo/context/site/serm"
}}

–ü—Ä–∞–≤–∏–ª–∞:
- –ó–∞–ø–æ–ª–Ω—è–π –¢–û–õ–¨–ö–û –ø–æ–ª—è, –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ—Ç–æ—Ä—ã—Ö –Ø–í–ù–û –µ—Å—Ç—å –≤ –ø–µ—Ä–µ–ø–∏—Å–∫–µ
- –ù–µ –≤—ã–¥—É–º—ã–≤–∞–π –∏ –Ω–µ –¥–æ–¥—É–º—ã–≤–∞–π
- –ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ—Ç ‚Äî –Ω–µ –≤–∫–ª—é—á–∞–π –ø–æ–ª–µ –≤ JSON
- –ü–∏—à–∏ –∫—Ä–∞—Ç–∫–æ, –ø–æ –¥–µ–ª—É
- client_name –∏–∑–≤–ª–µ–∫–∏ –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è —á–∞—Ç–∞ –∏–ª–∏ –ø–µ—Ä–µ–ø–∏—Å–∫–∏"""

        result = self._call_gpt(system_prompt, conversation_text, max_tokens=400, temperature=0.3)

        if not result:
            return {}

        try:
            import json
            result = result.strip()
            if result.startswith("```"):
                result = result.split("```")[1]
                if result.startswith("json"):
                    result = result[4:]
            result = result.strip()

            data = json.loads(result)
            # –§–∏–ª—å—Ç—Ä—É–µ–º –ø—É—Å—Ç—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
            return {k: v for k, v in data.items() if v and v.strip()}
        except Exception as e:
            logger.error(f"Error parsing client info: {e}")
            return {}


# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä
ai_service = OpenAIService()
