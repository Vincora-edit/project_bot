"""
–°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å OpenAI GPT.

–í—Å–µ –≤—ã–∑–æ–≤—ã GPT —Å–æ–±—Ä–∞–Ω—ã –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ —Å –µ–¥–∏–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫.
"""

from openai import OpenAI

from src.config import settings
from src.config.settings import TONE_OF_VOICE
from src.utils.logging import get_logger


logger = get_logger(__name__)


class OpenAIService:
    """–°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å OpenAI API."""

    def __init__(self):
        self._client: OpenAI | None = None

    @property
    def client(self) -> OpenAI:
        """–õ–µ–Ω–∏–≤–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞."""
        if self._client is None:
            self._client = OpenAI(api_key=settings.openai_api_key)
        return self._client

    def _call_gpt(
        self,
        system_prompt: str,
        user_content: str,
        max_tokens: int = 300,
        temperature: float = 0.7
    ) -> str:
        """
        –ë–∞–∑–æ–≤—ã–π –≤—ã–∑–æ–≤ GPT.

        Args:
            system_prompt: –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç
            user_content: –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            max_tokens: –ú–∞–∫—Å–∏–º—É–º —Ç–æ–∫–µ–Ω–æ–≤ –≤ –æ—Ç–≤–µ—Ç–µ
            temperature: –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏

        Returns:
            str: –û—Ç–≤–µ—Ç GPT –∏–ª–∏ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ
        """
        try:
            response = self.client.chat.completions.create(
                model=settings.openai_model,
                messages=[
                    {"role": "system", "content": system_prompt},
                    {"role": "user", "content": user_content},
                ],
                max_tokens=max_tokens,
                temperature=temperature,
            )
            return (response.choices[0].message.content or "").strip()
        except Exception as e:
            logger.error(f"GPT call error: {e}")
            return ""

    async def check_if_need_answer(self, text: str, context: str = "") -> bool:
        """
        –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –Ω—É–∂–µ–Ω –ª–∏ –æ—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞.

        Args:
            text: –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
            context: –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

        Returns:
            bool: True –µ—Å–ª–∏ –Ω—É–∂–µ–Ω –æ—Ç–≤–µ—Ç
        """
        user_content = text or ""
        if context:
            user_content = f"–ö–æ–Ω—Ç–µ–∫—Å—Ç (–ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è):\n{context}\n\n–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞:\n{text}"

        system_prompt = (
            "–û–ø—Ä–µ–¥–µ–ª–∏, –Ω—É–∂–Ω–æ –ª–∏ –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –ù–û–í–û–ï —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞, —É—á–∏—Ç—ã–≤–∞—è –∫–æ–Ω—Ç–µ–∫—Å—Ç.\n"
            "–í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û 1 –∏–ª–∏ 0:\n"
            "1 ‚Äî –µ—Å–ª–∏ —ç—Ç–æ –≤–æ–ø—Ä–æ—Å/–ø—Ä–æ—Å—å–±–∞/–ø—Ä–æ–±–ª–µ–º–∞/–ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Ç–µ–º—ã\n"
            "0 ‚Äî –µ—Å–ª–∏ —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ '–æ–∫', '—Å–ø–∞—Å–∏–±–æ', —ç–º–æ–¥–∑–∏\n\n"
            "–í–ê–ñ–ù–û: –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –ø–∏—à–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–¥—Ä—è–¥ (—Ä–∞–∑–≤–∏–≤–∞—è –º—ã—Å–ª—å) - —ç—Ç–æ –û–î–ù–ê –ø—Ä–æ—Å—å–±–∞, "
            "–Ω—É–∂–µ–Ω –æ—Ç–≤–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ –ü–û–°–õ–ï–î–ù–ï–ï —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Ü–µ–ø–æ—á–∫–µ."
        )

        result = self._call_gpt(system_prompt, user_content, max_tokens=1)
        return result == "1"

    async def generate_suggestion_and_tasks(
        self,
        client_text: str,
        context: str = ""
    ) -> tuple[str, list[str]]:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –∏ —Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á.

        Args:
            client_text: –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞
            context: –ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞

        Returns:
            tuple[str, list[str]]: (–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç, —Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á)
        """
        user_content = client_text or ""
        if context:
            user_content = f"–ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞:\n{context}\n\n–ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞:\n{client_text}"

        system_prompt = (
            "–¢—ã –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø—Ä–æ–¥–∂–µ–∫—Ç–∞ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤–æ–≥–æ –∞–≥–µ–Ω—Ç—Å—Ç–≤–∞. "
            "–£—á–∏—Ç—ã–≤–∞–π –í–ï–°–¨ –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞.\n\n"
            f"–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ø–∏—à–∏ –≤ –Ω–∞—à–µ–º tone of voice:\n{TONE_OF_VOICE}\n\n"
            "–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π:\n"
            "1) REPLY ‚Äî –æ—Ç–≤–µ—Ç –∫–ª–∏–µ–Ω—Ç—É (1-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –∂–∏–≤–æ –∏ –ø–æ-–¥—Ä—É–∂–µ—Å–∫–∏)\n"
            "2) TASKS ‚Äî 3-5 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –∑–∞–¥–∞—á –¥–ª—è –∫–æ–º–∞–Ω–¥—ã\n\n"
            "–§–æ—Ä–º–∞—Ç:\n"
            "REPLY: <—Ç–µ–∫—Å—Ç>\n"
            "TASKS:\n"
            "- <–∑–∞–¥–∞—á–∞ 1>\n"
            "- <–∑–∞–¥–∞—á–∞ 2>"
        )

        text = self._call_gpt(system_prompt, user_content)

        # –ü–∞—Ä—Å–∏–º –æ—Ç–≤–µ—Ç
        reply = ""
        tasks: list[str] = []

        if "REPLY:" in text:
            part = text.split("REPLY:", 1)[1]
            if "TASKS:" in part:
                reply_part, tasks_part = part.split("TASKS:", 1)
                reply = reply_part.strip()
                for line in tasks_part.splitlines():
                    line = line.strip()
                    if line.startswith("-"):
                        tasks.append(line.lstrip("-").strip())
            else:
                reply = part.strip()

        # –§–æ–ª–±—ç–∫–∏
        if not reply:
            reply = "–°–ø–∞—Å–∏–±–æ –∑–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é! –ü—Ä–∏–Ω—è–ª, —Å–µ–π—á–∞—Å –æ–±—Ä–∞–±–æ—Ç–∞–µ–º –∏ –≤–µ—Ä–Ω—ë–º—Å—è."
        if not tasks:
            tasks = ["–û–±—Ä–∞–±–æ—Ç–∞—Ç—å –∑–∞–ø—Ä–æ—Å –∫–ª–∏–µ–Ω—Ç–∞", "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–µ—Ç–∞–ª–∏", "–í–µ—Ä–Ω—É—Ç—å—Å—è —Å –æ—Ç–≤–µ—Ç–æ–º"]

        return reply, tasks

    async def generate_response_variants(
        self,
        client_text: str,
        context: str = ""
    ) -> list[dict]:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–∞ –∫–ª–∏–µ–Ω—Ç—É.

        Args:
            client_text: –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞
            context: –ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞

        Returns:
            list[dict]: –°–ø–∏—Å–æ–∫ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ [{"tone": "...", "text": "..."}]
        """
        user_content = client_text or ""
        if context:
            user_content = f"–ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞:\n{context}\n\n–°–æ–æ–±—â–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞:\n{client_text}"

        system_prompt = (
            "–¢—ã –ø–æ–º–æ—â–Ω–∏–∫ –ø—Ä–æ–¥–∂–µ–∫—Ç-–º–µ–Ω–µ–¥–∂–µ—Ä–∞ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤–æ–≥–æ –∞–≥–µ–Ω—Ç—Å—Ç–≤–∞.\n\n"
            f"–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ø–∏—à–∏ –≤ –Ω–∞—à–µ–º tone of voice:\n{TONE_OF_VOICE}\n\n"
            "–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –≤–∞—Ä–∏–∞–Ω—Ç –æ—Ç–≤–µ—Ç–∞ –∫–ª–∏–µ–Ω—Ç—É.\n"
            "–û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω:\n"
            "- –û—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –∑–∞–ø—Ä–æ—Å –∫–ª–∏–µ–Ω—Ç–∞\n"
            "- –ë—ã—Ç—å –≥–æ—Ç–æ–≤—ã–º –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ (–±–µ–∑ –ø—Ä–∞–≤–æ–∫)\n"
            "- –ë—ã—Ç—å –∂–∏–≤—ã–º, –∫–∞–∫ —Ä–∞–∑–≥–æ–≤–æ—Ä —Å –¥—Ä—É–≥–æ–º\n"
            "- –°–æ–¥–µ—Ä–∂–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –∏–ª–∏ —Å—Ä–æ–∫–∏ –µ—Å–ª–∏ —É–º–µ—Å—Ç–Ω–æ\n\n"
            "–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:\n"
            "–î–†–£–ñ–ï–õ–Æ–ë–ù–´–ô:\n<—Ç–µ–∫—Å—Ç>\n\n"
        )

        text = self._call_gpt(system_prompt, user_content, max_tokens=500)

        # –ü–∞—Ä—Å–∏–º
        variants = []
        if "–î–†–£–ñ–ï–õ–Æ–ë–ù–´–ô:" in text:
            variant_text = text.split("–î–†–£–ñ–ï–õ–Æ–ë–ù–´–ô:", 1)[1].strip()
            if variant_text:
                variants.append({"tone": "–î—Ä—É–∂–µ–ª—é–±–Ω—ã–π", "text": variant_text})

        # –§–æ–ª–±—ç–∫
        if not variants:
            variants = [
                {"tone": "–î—Ä—É–∂–µ–ª—é–±–Ω—ã–π", "text": "–ü—Ä–∏–≤–µ—Ç! –°–ø–∞—Å–∏–±–æ —á—Ç–æ –Ω–∞–ø–∏—Å–∞–ª, —É–∂–µ —Ä–∞–±–æ—Ç–∞—é –Ω–∞–¥ —ç—Ç–∏–º üòä"}
            ]

        return variants

    async def generate_holiday_greeting(
        self,
        holiday_name: str,
        chat_name: str
    ) -> str:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ —Å –ø—Ä–∞–∑–¥–Ω–∏–∫–æ–º.

        Args:
            holiday_name: –ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∞–∑–¥–Ω–∏–∫–∞
            chat_name: –ù–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞ (–¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Å—Ñ–µ—Ä—ã –∫–ª–∏–µ–Ω—Ç–∞)

        Returns:
            str: –¢–µ–∫—Å—Ç –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è
        """
        system_prompt = (
            "–¢—ã –ø–æ–º–æ—â–Ω–∏–∫ –ø—Ä–æ–¥–∂–µ–∫—Ç-–º–µ–Ω–µ–¥–∂–µ—Ä–∞ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤–æ–≥–æ –∞–≥–µ–Ω—Ç—Å—Ç–≤–∞.\n"
            "–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –∫–æ—Ä–æ—Ç–∫–æ–µ (2-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è) —Ç—ë–ø–ª–æ–µ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ —Å –ø—Ä–∞–∑–¥–Ω–∏–∫–æ–º.\n\n"
            f"–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ø–∏—à–∏ –≤ –Ω–∞—à–µ–º tone of voice:\n{TONE_OF_VOICE}\n\n"
            "–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:\n"
            "- –£–ø–æ–º—è–Ω–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∞–∑–¥–Ω–∏–∫–∞\n"
            "- –ï—Å–ª–∏ –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è —á–∞—Ç–∞ –ø–æ–Ω—è—Ç–Ω–∞ —Å—Ñ–µ—Ä–∞ –∫–ª–∏–µ–Ω—Ç–∞ ‚Äî –¥–æ–±–∞–≤—å –ø–æ–∂–µ–ª–∞–Ω–∏–µ –ø—Ä–æ –µ–≥–æ –±–∏–∑–Ω–µ—Å\n"
            "- –ü–∏—à–∏ –∫–∞–∫ –¥—Ä—É–≥—É, –Ω–æ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ\n"
            "- –ú–æ–∂–Ω–æ 1-2 —ç–º–æ–¥–∑–∏\n"
            "- –ù–ï –Ω–∞—á–∏–Ω–∞–π —Å '–£–≤–∞–∂–∞–µ–º—ã–π' ‚Äî —ç—Ç–æ —Ñ–æ—Ä–º–∞–ª—å–Ω–æ\n"
        )

        user_content = f"–ü—Ä–∞–∑–¥–Ω–∏–∫: {holiday_name}\n–ö–ª–∏–µ–Ω—Ç/—á–∞—Ç: {chat_name}"

        result = self._call_gpt(system_prompt, user_content, max_tokens=200)

        if not result:
            result = f"üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º —Å –ø—Ä–∞–∑–¥–Ω–∏–∫–æ–º ‚Äî {holiday_name}! –ñ–µ–ª–∞–µ–º —É—Å–ø–µ—Ö–æ–≤, –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏—è –∏ –æ—Ç–ª–∏—á–Ω–æ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è!"

        return result

    async def generate_stage_message(
        self,
        prompt: str,
        deal: dict,
        chat_history: str,
        template: str = ""
    ) -> str:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —Å—Ç–∞–¥–∏–∏ —Å–¥–µ–ª–∫–∏.

        Args:
            prompt: –ü—Ä–æ–º–ø—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
            deal: –î–∞–Ω–Ω—ã–µ —Å–¥–µ–ª–∫–∏
            chat_history: –ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞
            template: –ë–∞–∑–æ–≤—ã–π —à–∞–±–ª–æ–Ω (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

        Returns:
            str: –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        """
        context = f"""
## –î–∞–Ω–Ω—ã–µ –æ —Å–¥–µ–ª–∫–µ
- –ù–∞–∑–≤–∞–Ω–∏–µ: {deal.get('deal_name', '–ù–µ —É–∫–∞–∑–∞–Ω–æ')}
- –£—Å–ª—É–≥–∞: {deal.get('service_type', 'geo')}
- ID —Å–¥–µ–ª–∫–∏: {deal.get('deal_id', '')}

## –ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–ø–∏—Å–∫–∏ —Å –∫–ª–∏–µ–Ω—Ç–æ–º (–ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è)
{chat_history}

## –ë–∞–∑–æ–≤—ã–π —à–∞–±–ª–æ–Ω —Å–æ–æ–±—â–µ–Ω–∏—è (–∏—Å–ø–æ–ª—å–∑—É–π –∫–∞–∫ –æ—Å–Ω–æ–≤—É, –Ω–æ –∞–¥–∞–ø—Ç–∏—Ä—É–π)
{template if template else '–®–∞–±–ª–æ–Ω –Ω–µ —É–∫–∞–∑–∞–Ω ‚Äî —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –Ω—É–ª—è'}
"""

        system_prompt = f"""{TONE_OF_VOICE}

## –¢–≤–æ—è –∑–∞–¥–∞—á–∞
{prompt}

## –í–∞–∂–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞
1. –ü–∏—à–∏ –æ—Ç –ª–∏—Ü–∞ –ø—Ä–æ–¥–∂–µ–∫—Ç-–º–µ–Ω–µ–¥–∂–µ—Ä–∞ –∞–≥–µ–Ω—Ç—Å—Ç–≤–∞
2. –£—á–∏—Ç—ã–≤–∞–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–µ—Ä–µ–ø–∏—Å–∫–∏ ‚Äî –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —á—Ç–æ-—Ç–æ –æ–±—Å—É–∂–¥–∞–ª, –º–æ–∂–Ω–æ —ç—Ç–æ —É–ø–æ–º—è–Ω—É—Ç—å
3. –°–æ–æ–±—â–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –∫–æ—Ä–æ—Ç–∫–∏–º (2-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
4. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Ñ–æ—Ä–º–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞—â–µ–Ω–∏—è —Ç–∏–ø–∞ "–£–≤–∞–∂–∞–µ–º—ã–π"
5. –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å 1-2 —ç–º–æ–¥–∑–∏, –Ω–æ –Ω–µ –ø–µ—Ä–µ–±–∞—Ä—â–∏–≤–∞–π
6. –ï—Å–ª–∏ –≤ –∏—Å—Ç–æ—Ä–∏–∏ –≤–∏–¥–Ω–æ –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞ ‚Äî –º–æ–∂–µ—à—å –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –ø–æ –∏–º–µ–Ω–∏
"""

        return self._call_gpt(system_prompt, context, max_tokens=300)

    async def generate_upsell_suggestion(
        self,
        deal: dict,
        chat_history: str
    ) -> str:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ø—Ä–æ–¥–∞–∂–∏.

        Args:
            deal: –î–∞–Ω–Ω—ã–µ —Å–¥–µ–ª–∫–∏
            chat_history: –ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞

        Returns:
            str: –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ø—Ä–æ–¥–∞–∂–∏
        """
        services = """
–ù–∞—à–∏ —É—Å–ª—É–≥–∏:
1. –ì–µ–æ–º–∞—Ä–∫–µ—Ç–∏–Ω–≥ - –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ –Ω–∞ –∫–∞—Ä—Ç–∞—Ö (–Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç—ã, 2–ì–ò–°, Google Maps), —Ä–∞–±–æ—Ç–∞ —Å –æ—Ç–∑—ã–≤–∞–º–∏, –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫
2. –°–∞–π—Ç—ã - —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –∏ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ —Å–∞–π—Ç–æ–≤, SEO-–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
3. –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–∞—è —Ä–µ–∫–ª–∞–º–∞ - –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –∏ –≤–µ–¥–µ–Ω–∏–µ —Ä–µ–∫–ª–∞–º—ã –≤ –Ø–Ω–¥–µ–∫—Å –î–∏—Ä–µ–∫—Ç, Google Ads
4. –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è - —á–∞—Ç-–±–æ—Ç—ã, CRM-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏, –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤
"""

        prompt = f"""–¢—ã - –æ–ø—ã—Ç–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç-–º–µ–Ω–µ–¥–∂–µ—Ä. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∫–ª–∏–µ–Ω—Ç–∞ –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –¥–æ–ø—Ä–æ–¥–∞–∂—É.

{services}

–¢–µ–∫—É—â–∞—è —É—Å–ª—É–≥–∞ –∫–ª–∏–µ–Ω—Ç–∞: {deal.get('service_type', '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')}
–ù–∞–∑–≤–∞–Ω–∏–µ —Å–¥–µ–ª–∫–∏: {deal.get('deal_name', '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')}

–ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–ø–∏—Å–∫–∏ —Å –∫–ª–∏–µ–Ω—Ç–æ–º:
{chat_history}

–ó–∞–¥–∞—á–∞:
1. –û–ø—Ä–µ–¥–µ–ª–∏ –∫–∞–∫—É—é –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é —É—Å–ª—É–≥—É –º–æ–∂–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å —ç—Ç–æ–º—É –∫–ª–∏–µ–Ω—Ç—É
2. –ù–∞–ø–∏—à–∏ –∫–æ—Ä–æ—Ç–∫–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ –ø–æ—á–µ–º—É –∏–º–µ–Ω–Ω–æ —ç—Ç–∞ —É—Å–ª—É–≥–∞ –ø–æ–¥–æ–π–¥—ë—Ç
3. –ù–∞–ø–∏—à–∏ –≥–æ—Ç–æ–≤–æ–µ –ø—Ä–æ–¥–∞—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ (3-5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π, –Ω–∞ "–í—ã", –∂–∏–≤–æ–π —Å—Ç–∏–ª—å)

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:
–£–°–õ–£–ì–ê: [–Ω–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏]
–ü–û–ß–ï–ú–£: [–æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ –≤ 1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è]
–°–û–û–ë–©–ï–ù–ò–ï:
[–≥–æ—Ç–æ–≤—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–ª–∏–µ–Ω—Ç—É]"""

        return self._call_gpt(
            "–¢—ã –æ–ø—ã—Ç–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç-–º–µ–Ω–µ–¥–∂–µ—Ä –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤–æ–≥–æ –∞–≥–µ–Ω—Ç—Å—Ç–≤–∞.",
            prompt,
            max_tokens=500
        )

    async def generate_digest(
        self,
        messages: list[dict],
        client_info: dict | None = None,
        period: str = "–∑–∞ –ø–µ—Ä–∏–æ–¥"
    ) -> str:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –¥–∞–π–¥–∂–µ—Å—Ç –ø–æ –ø–µ—Ä–µ–ø–∏—Å–∫–µ —Å –∫–ª–∏–µ–Ω—Ç–æ–º.

        Args:
            messages: –°–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π [{from_name, text, is_project, timestamp}]
            client_info: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
            period: –û–ø–∏—Å–∞–Ω–∏–µ –ø–µ—Ä–∏–æ–¥–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä "–∑–∞ –Ω–µ–¥–µ–ª—é")

        Returns:
            str: –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–∞–π–¥–∂–µ—Å—Ç
        """
        if not messages:
            return "üì≠ –ó–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ."

        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
        conversation = []
        for msg in messages:
            sender = "üë§ –ö–ª–∏–µ–Ω—Ç" if not msg.get("is_project") else "üíº –ü—Ä–æ–¥–∂–µ–∫—Ç"
            text = msg.get("text", "")[:500]  # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É
            conversation.append(f"{sender}: {text}")

        conversation_text = "\n".join(conversation[-100:])  # –ü–æ—Å–ª–µ–¥–Ω–∏–µ 100 —Å–æ–æ–±—â–µ–Ω–∏–π

        # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–ª–∏–µ–Ω—Ç–µ
        client_context = ""
        if client_info:
            fields = []
            if client_info.get("client_name"):
                fields.append(f"–ö–ª–∏–µ–Ω—Ç: {client_info['client_name']}")
            if client_info.get("decision_maker"):
                fields.append(f"–õ–ü–†: {client_info['decision_maker']}")
            if client_info.get("service_type"):
                fields.append(f"–£—Å–ª—É–≥–∞: {client_info['service_type']}")
            if client_info.get("preferences"):
                fields.append(f"–õ—é–±–∏—Ç: {client_info['preferences']}")
            if client_info.get("dislikes"):
                fields.append(f"–ù–µ –ª—é–±–∏—Ç: {client_info['dislikes']}")
            if fields:
                client_context = "## –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ\n" + "\n".join(fields) + "\n\n"

        system_prompt = f"""–¢—ã –∞–Ω–∞–ª–∏—Ç–∏–∫ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤–æ–≥–æ –∞–≥–µ–Ω—Ç—Å—Ç–≤–∞. –°–æ—Å—Ç–∞–≤—å –∫—Ä–∞—Ç–∫–∏–π –¥–∞–π–¥–∂–µ—Å—Ç –ø–µ—Ä–µ–ø–∏—Å–∫–∏ —Å –∫–ª–∏–µ–Ω—Ç–æ–º {period}.

{client_context}## –§–æ—Ä–º–∞—Ç –¥–∞–π–¥–∂–µ—Å—Ç–∞
–û—Ç–≤–µ—Ç –°–¢–†–û–ì–û –≤ —Ç–∞–∫–æ–º —Ñ–æ—Ä–º–∞—Ç–µ:

üìä –°–¢–ê–¢–£–°: [–û–±—â–µ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞: –¥–æ–≤–æ–ª–µ–Ω/–Ω–µ–π—Ç—Ä–∞–ª–µ–Ω/–µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã/–Ω–µ–¥–æ–≤–æ–ª–µ–Ω]

üîë –ö–õ–Æ–ß–ï–í–´–ï –¢–ï–ú–´:
‚Ä¢ [—Ç–µ–º–∞ 1]
‚Ä¢ [—Ç–µ–º–∞ 2]
‚Ä¢ [—Ç–µ–º–∞ 3]

‚ö†Ô∏è –ü–†–û–ë–õ–ï–ú–´/–ó–ê–ü–†–û–°–´:
‚Ä¢ [–µ—Å–ª–∏ –±—ã–ª–∏ ‚Äî –ø–µ—Ä–µ—á–∏—Å–ª–∏, –µ—Å–ª–∏ –Ω–µ—Ç ‚Äî "–ù–µ—Ç –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø—Ä–æ–±–ª–µ–º"]

‚úÖ –í–´–ü–û–õ–ù–ï–ù–û:
‚Ä¢ [—á—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ –∫–æ–º–∞–Ω–¥–æ–π]

üìã –ù–£–ñ–ù–û –°–î–ï–õ–ê–¢–¨:
‚Ä¢ [—á—Ç–æ –æ—Å—Ç–∞–ª–æ—Å—å —Å–¥–µ–ª–∞—Ç—å –∏–ª–∏ –Ω–∞ —á—Ç–æ –æ–±—Ä–∞—Ç–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ]

üí° –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:
‚Ä¢ [1-2 —Å–æ–≤–µ—Ç–∞ –¥–ª—è –ø—Ä–æ–¥–∂–µ–∫—Ç–∞]

## –ü—Ä–∞–≤–∏–ª–∞
- –ü–∏—à–∏ –∫—Ä–∞—Ç–∫–æ, –ø–æ –¥–µ–ª—É
- –í—ã–¥–µ–ª—è–π –≥–ª–∞–≤–Ω–æ–µ
- –ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –º–∞–ª–æ ‚Äî –ø–∏—à–∏ "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö"
- –ù–µ –≤—ã–¥—É–º—ã–≤–∞–π —Ç–æ, —á–µ–≥–æ –Ω–µ—Ç –≤ –ø–µ—Ä–µ–ø–∏—Å–∫–µ"""

        result = self._call_gpt(system_prompt, conversation_text, max_tokens=800, temperature=0.5)

        if not result:
            result = "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–∞–π–¥–∂–µ—Å—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."

        return result

    async def extract_commitment(
        self,
        message_text: str,
        context: str = ""
    ) -> dict | None:
        """
        –ò–∑–≤–ª–µ–∫–∞–µ—Ç –¥–æ–≥–æ–≤–æ—Ä—ë–Ω–Ω–æ—Å—Ç—å/–æ–±–µ—â–∞–Ω–∏–µ –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–æ–¥–∂–µ–∫—Ç–∞.

        Args:
            message_text: –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–æ–¥–∂–µ–∫—Ç–∞
            context: –ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞

        Returns:
            dict | None: {
                "has_commitment": bool,
                "text": str,  # –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–æ–≥–æ–≤–æ—Ä—ë–Ω–Ω–æ—Å—Ç–∏
                "deadline_type": "date" | "hours",  # –¢–∏–ø –¥–µ–¥–ª–∞–π–Ω–∞
                "deadline_date": "YYYY-MM-DD" | null,  # –ö–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –¥–∞—Ç–∞ (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω –¥–µ–Ω—å)
                "deadline_time": "HH:MM" | null,  # –í—Ä–µ–º—è (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ)
                "remind_in_hours": int  # –ß–µ—Ä–µ–∑ —Å–∫–æ–ª—å–∫–æ —á–∞—Å–æ–≤ (–¥–ª—è –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã—Ö —Å—Ä–æ–∫–æ–≤)
            }
        """
        from datetime import datetime
        from src.utils.time_utils import now_local

        # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É –∏ –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        now = now_local()
        weekday_names = ["–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫", "–≤—Ç–æ—Ä–Ω–∏–∫", "—Å—Ä–µ–¥–∞", "—á–µ—Ç–≤–µ—Ä–≥", "–ø—è—Ç–Ω–∏—Ü–∞", "—Å—É–±–±–æ—Ç–∞", "–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ"]
        current_weekday = weekday_names[now.weekday()]

        # –ö–æ–Ω—Ç–µ–∫—Å—Ç –ù–ï –ø–µ—Ä–µ–¥–∞—ë–º ‚Äî –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –¢–û–õ–¨–ö–û —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        # –ò–Ω–∞—á–µ GPT –Ω–∞—Ö–æ–¥–∏—Ç –æ–±–µ—â–∞–Ω–∏—è –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏ –ø—Ä–∏–ø–∏—Å—ã–≤–∞–µ—Ç –∏—Ö —Ç–µ–∫—É—â–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
        user_content = f"–°–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞:\n{message_text}\n\n–¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞: {now.strftime('%Y-%m-%d')} ({current_weekday})"

        system_prompt = """–¢—ã –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—à—å –û–î–ù–û –ö–û–ù–ö–†–ï–¢–ù–û–ï —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–æ–¥–∂–µ–∫—Ç-–º–µ–Ω–µ–¥–∂–µ—Ä–∞.
–û–ø—Ä–µ–¥–µ–ª–∏, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ –ò–ú–ï–ù–ù–û –≠–¢–û –°–û–û–ë–©–ï–ù–ò–ï –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –æ–±–µ—â–∞–Ω–∏–µ/–¥–æ–≥–æ–≤–æ—Ä—ë–Ω–Ω–æ—Å—Ç—å.

–í–ê–ñ–ù–û: –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π –¢–û–õ–¨–ö–û –ø–µ—Ä–µ–¥–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ! –ù–µ –≤—ã–¥—É–º—ã–≤–∞–π –æ–±–µ—â–∞–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ —Ç–µ–∫—Å—Ç–µ!

‚úÖ –≠–¢–û –û–ë–ï–©–ê–ù–ò–Ø (–Ω—É–∂–Ω–æ –Ω–∞–ø–æ–º–Ω–∏—Ç—å):
- "–ó–∞–≤—Ç—Ä–∞ –ø—Ä–∏—à–ª—é –æ—Ç—á—ë—Ç" ‚Üí –¥–∞, deadline_type: "date", deadline_date: –∑–∞–≤—Ç—Ä–∞—à–Ω—è—è –¥–∞—Ç–∞
- "–°–æ–∑–≤–æ–Ω–∏–º—Å—è –≤ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫" ‚Üí –¥–∞, deadline_type: "date", deadline_date: –¥–∞—Ç–∞ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫–∞
- "–î–æ –≤—Ç–æ—Ä–Ω–∏–∫–∞ —Å–¥–µ–ª–∞—é" ‚Üí –¥–∞, deadline_type: "date", deadline_date: –¥–∞—Ç–∞ –≤—Ç–æ—Ä–Ω–∏–∫–∞
- "–°–¥–µ–ª–∞—é –Ω–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ" ‚Üí –¥–∞, deadline_type: "date", deadline_date: –ø—è—Ç–Ω–∏—Ü–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–∏
- "–ó–∞–≤—Ç—Ä–∞ –≤ 13:00 —Å–æ–∑–≤–æ–Ω" ‚Üí –¥–∞, deadline_type: "date", deadline_date: –∑–∞–≤—Ç—Ä–∞, deadline_time: "13:00"
- "–£—Ç–æ—á–Ω—é —É –∫–æ–º–∞–Ω–¥—ã –∏ –≤–µ—Ä–Ω—É—Å—å" ‚Üí –¥–∞, deadline_type: "hours", remind_in_hours: 4
- "–ü–æ—Å–º–æ—Ç—Ä—é —Å–µ–≥–æ–¥–Ω—è" ‚Üí –¥–∞, deadline_type: "date", deadline_date: —Å–µ–≥–æ–¥–Ω—è
- "–í —Ç–µ—á–µ–Ω–∏–µ —á–∞—Å–∞ –æ—Ç–ø—Ä–∞–≤–ª—é" ‚Üí –¥–∞, deadline_type: "hours", remind_in_hours: 1
- "–í —Ç–µ—á–µ–Ω–∏–µ 2 —á–∞—Å–æ–≤ –ø—Ä–∏—à–ª—é" ‚Üí –¥–∞, deadline_type: "hours", remind_in_hours: 2
- "–í —Ç–µ—á–µ–Ω–∏–µ –¥–Ω—è —Å–¥–µ–ª–∞—é" ‚Üí –¥–∞, deadline_type: "hours", remind_in_hours: 8

‚ùå –≠–¢–û –ù–ï –û–ë–ï–©–ê–ù–ò–Ø (–ù–ï –Ω—É–∂–Ω–æ –Ω–∞–ø–æ–º–∏–Ω–∞—Ç—å):
- "–û–∫, –ø—Ä–∏–Ω—è–ª" ‚Üí –Ω–µ—Ç
- "–°–ø–∞—Å–∏–±–æ –∑–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é" ‚Üí –Ω–µ—Ç
- "–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ –¥–µ–ª–∞?" ‚Üí –Ω–µ—Ç
- "–∞ –ø–æ—Ç–æ–º /client" ‚Üí –Ω–µ—Ç, —ç—Ç–æ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è/–∫–æ–º–∞–Ω–¥–∞
- "–Ω–∞–ø–∏—à–∏ –µ–π /help" ‚Üí –Ω–µ—Ç, —ç—Ç–æ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥—Ä—É–≥–æ–º—É —á–µ–ª–æ–≤–µ–∫—É
- "–ø–æ—Ç–æ–º —Ä–∞—Å—Å–∫–∞–∂—É" ‚Üí –Ω–µ—Ç, —Å–ª–∏—à–∫–æ–º –Ω–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ
- "–¥–∞", "–Ω–µ—Ç", "–æ–∫", "–ø–æ–Ω—è–ª" ‚Üí –Ω–µ—Ç, —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
- –ö–æ–º–∞–Ω–¥—ã –±–æ—Ç—É (/help, /client, /digest) ‚Üí –Ω–µ—Ç
- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –∫–æ–ª–ª–µ–≥–∞–º ‚Üí –Ω–µ—Ç
- "–ú–æ–∂–µ–º —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ" ‚Üí –Ω–µ—Ç, —ç—Ç–æ –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï, –∞ –Ω–µ –æ–±–µ—â–∞–Ω–∏–µ
- "–ï—Å–ª–∏ —á—Ç–æ ‚Äî –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å" ‚Üí –Ω–µ—Ç, —É—Å–ª–æ–≤–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
- "–ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —Å–¥–µ–ª–∞–µ–º" ‚Üí –Ω–µ—Ç, —ç—Ç–æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å, –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ
- "–ú–æ–≥—É –ø—Ä–∏—Å–ª–∞—Ç—å –ø–æ–∑–∂–µ" ‚Üí –Ω–µ—Ç, —ç—Ç–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –±–µ–∑ –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞
- "–°–µ–π—á–∞—Å –ø–æ—Å–º–æ—Ç—Ä—é" ‚Üí –Ω–µ—Ç, —ç—Ç–æ —Ç–µ–∫—É—â–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ, –Ω–µ –±—É–¥—É—â–µ–µ –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ
- –õ—é–±—ã–µ –∫–æ—Ä–æ—Ç–∫–∏–µ —Ñ—Ä–∞–∑—ã –±–µ–∑ –Ø–í–ù–û–ì–û —É–∫–∞–∑–∞–Ω–∏—è –ö–û–ì–î–ê –∏ –ß–¢–û –±—É–¥–µ—Ç —Å–¥–µ–ª–∞–Ω–æ ‚Üí –Ω–µ—Ç

–ö–†–ò–¢–ï–†–ò–ò –ù–ê–°–¢–û–Ø–©–ï–ì–û –û–ë–ï–©–ê–ù–ò–Ø (–¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –í–°–ï):
1. –ï—Å—Ç—å –ö–û–ù–ö–†–ï–¢–ù–û–ï –î–ï–ô–°–¢–í–ò–ï (–ø—Ä–∏—à–ª—é, —Å–¥–µ–ª–∞—é, –ø–æ–∑–≤–æ–Ω—é, –æ—Ç–ø—Ä–∞–≤–ª—é)
2. –ï—Å—Ç—å –£–ö–ê–ó–ê–ù–ò–ï –í–†–ï–ú–ï–ù–ò (–∑–∞–≤—Ç—Ä–∞, —á–µ—Ä–µ–∑ —á–∞—Å, –Ω–∞ –Ω–µ–¥–µ–ª–µ, —Å–µ–≥–æ–¥–Ω—è –≤–µ—á–µ—Ä–æ–º, –¥–æ –≤—Ç–æ—Ä–Ω–∏–∫–∞)
3. –≠—Ç–æ –û–ë–Ø–ó–ê–¢–ï–õ–¨–°–¢–í–û, –∞ –Ω–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –∏–ª–∏ –∫–æ–Ω—Å—Ç–∞—Ç–∞—Ü–∏—è
4. –ê–¥—Ä–µ—Å–æ–≤–∞–Ω–æ –ö–õ–ò–ï–ù–¢–£ (–Ω–µ –∫–æ–ª–ª–µ–≥–µ, –Ω–µ –±–æ—Ç—É)

–ï—Å–ª–∏ —Ö–æ—Ç—è –±—ã –û–î–ò–ù –∫—Ä–∏—Ç–µ—Ä–∏–π –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω ‚Äî —ç—Ç–æ –ù–ï –æ–±–µ—â–∞–Ω–∏–µ!

–í–ê–ñ–ù–û: –õ—É—á—à–µ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –æ–±–µ—â–∞–Ω–∏–µ, —á–µ–º —Å–æ–∑–¥–∞—Ç—å –ª–æ–∂–Ω–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ!

–û—Ç–≤–µ—Ç—å –°–¢–†–û–ì–û –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON:
{
  "has_commitment": true/false,
  "text": "–∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ",
  "deadline_type": "date" –∏–ª–∏ "hours",
  "deadline_date": "YYYY-MM-DD" –∏–ª–∏ null,
  "deadline_time": "HH:MM" –∏–ª–∏ null,
  "remind_in_hours": —á–∏—Å–ª–æ –∏–ª–∏ null
}

–ü–†–ê–í–ò–õ–ê –û–ü–†–ï–î–ï–õ–ï–ù–ò–Ø –î–ï–î–õ–ê–ô–ù–ê:
- –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω –î–ï–ù–¨ ("–∑–∞–≤—Ç—Ä–∞", "–≤ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫", "–¥–æ –≤—Ç–æ—Ä–Ω–∏–∫–∞", "–Ω–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ"):
  ‚Üí deadline_type: "date"
  ‚Üí deadline_date: –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –¥–∞—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD
  ‚Üí deadline_time: —É–∫–∞–∑–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è –∏–ª–∏ null (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –Ω–∞–ø–æ–º–Ω–∏–º –≤ 17:00)

- –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ –û–¢–ù–û–°–ò–¢–ï–õ–¨–ù–û–ï –í–†–ï–ú–Ø ("—á–µ—Ä–µ–∑ —á–∞—Å", "–≤ —Ç–µ—á–µ–Ω–∏–µ 2 —á–∞—Å–æ–≤", "—Å–∫–æ—Ä–æ"):
  ‚Üí deadline_type: "hours"
  ‚Üí remind_in_hours: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞—Å–æ–≤

- "—Å–µ–≥–æ–¥–Ω—è" –±–µ–∑ –≤—Ä–µ–º–µ–Ω–∏ ‚Üí deadline_type: "date", deadline_date: —Ç–µ–∫—É—â–∞—è –¥–∞—Ç–∞, deadline_time: null
- "–∑–∞–≤—Ç—Ä–∞" –±–µ–∑ –≤—Ä–µ–º–µ–Ω–∏ ‚Üí deadline_type: "date", deadline_date: –∑–∞–≤—Ç—Ä–∞—à–Ω—è—è –¥–∞—Ç–∞, deadline_time: null
- "–¥–æ –≤—Ç–æ—Ä–Ω–∏–∫–∞" ‚Üí deadline_type: "date", deadline_date: –¥–∞—Ç–∞ –≤—Ç–æ—Ä–Ω–∏–∫–∞, deadline_time: null
- "–≤ 13:00" –∏–ª–∏ "–∫ 15:00" ‚Üí –¥–æ–±–∞–≤—å deadline_time

–ï—Å–ª–∏ –æ–±–µ—â–∞–Ω–∏—è –Ω–µ—Ç, –≤–µ—Ä–Ω–∏:
{"has_commitment": false, "text": "", "deadline_type": null, "deadline_date": null, "deadline_time": null, "remind_in_hours": null}"""

        result = self._call_gpt(system_prompt, user_content, max_tokens=100, temperature=0.3)

        if not result:
            return None

        # –ü–∞—Ä—Å–∏–º JSON
        try:
            import json
            # –û—á–∏—â–∞–µ–º –æ—Ç –≤–æ–∑–º–æ–∂–Ω—ã—Ö markdown-–æ–±—ë—Ä—Ç–æ–∫
            result = result.strip()
            if result.startswith("```"):
                result = result.split("```")[1]
                if result.startswith("json"):
                    result = result[4:]
            result = result.strip()

            data = json.loads(result)
            if data.get("has_commitment"):
                return data
            return None
        except Exception as e:
            logger.error(f"Error parsing commitment: {e}, result: {result}")
            return None

    async def extract_client_info_from_history(
        self,
        messages: list[dict],
        chat_name: str
    ) -> dict:
        """
        –ò–∑–≤–ª–µ–∫–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–ª–∏–µ–Ω—Ç–µ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ –ø–µ—Ä–µ–ø–∏—Å–∫–∏.

        Args:
            messages: –°–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
            chat_name: –ù–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞

        Returns:
            dict —Å –ø–æ–ª—è–º–∏: client_name, decision_maker, contact_person,
                          preferences, dislikes, communication_style, service_type
        """
        if not messages:
            return {}

        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
        conversation = []
        for msg in messages[-150:]:  # –ü–æ—Å–ª–µ–¥–Ω–∏–µ 150 —Å–æ–æ–±—â–µ–Ω–∏–π
            sender = "–ö–ª–∏–µ–Ω—Ç" if not msg.get("is_project") else "–ü—Ä–æ–¥–∂–µ–∫—Ç"
            text = msg.get("text", "")[:300]
            conversation.append(f"{sender}: {text}")

        conversation_text = "\n".join(conversation)

        system_prompt = f"""–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø–µ—Ä–µ–ø–∏—Å–∫—É —Å –∫–ª–∏–µ–Ω—Ç–æ–º –∏ –∏–∑–≤–ª–µ–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.
–ù–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞: {chat_name}

–í–µ—Ä–Ω–∏ JSON —Å–æ —Å–ª–µ–¥—É—é—â–∏–º–∏ –ø–æ–ª—è–º–∏ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ø–í–ù–û –µ—Å—Ç—å –≤ –ø–µ—Ä–µ–ø–∏—Å–∫–µ):

{{
  "client_name": "–Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏/–ø—Ä–æ–µ–∫—Ç–∞ –∫–ª–∏–µ–Ω—Ç–∞",
  "decision_maker": "–õ–ü–† - –∫—Ç–æ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ä–µ—à–µ–Ω–∏—è (–∏–º—è, –¥–æ–ª–∂–Ω–æ—Å—Ç—å)",
  "contact_person": "–∫–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ –ª–∏—Ü–æ, —Å –∫–µ–º –æ–±—â–∞–µ–º—Å—è (–∏–º—è)",
  "preferences": "—á—Ç–æ –∫–ª–∏–µ–Ω—Ç—É –Ω—Ä–∞–≤–∏—Ç—Å—è, –≤–∞–∂–Ω–æ (–∫—Ä–∞—Ç–∫–æ)",
  "dislikes": "—á—Ç–æ –Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è, —Ä–∞–∑–¥—Ä–∞–∂–∞–µ—Ç (–∫—Ä–∞—Ç–∫–æ)",
  "communication_style": "—Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π/–¥—Ä—É–∂–µ—Å–∫–∏–π/–¥–µ–ª–æ–≤–æ–π",
  "service_type": "—Ç–∏–ø —É—Å–ª—É–≥–∏: geo/context/site/serm"
}}

–ü—Ä–∞–≤–∏–ª–∞:
- –ó–∞–ø–æ–ª–Ω—è–π –¢–û–õ–¨–ö–û –ø–æ–ª—è, –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ—Ç–æ—Ä—ã—Ö –Ø–í–ù–û –µ—Å—Ç—å –≤ –ø–µ—Ä–µ–ø–∏—Å–∫–µ
- –ù–µ –≤—ã–¥—É–º—ã–≤–∞–π –∏ –Ω–µ –¥–æ–¥—É–º—ã–≤–∞–π
- –ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ—Ç ‚Äî –Ω–µ –≤–∫–ª—é—á–∞–π –ø–æ–ª–µ –≤ JSON
- –ü–∏—à–∏ –∫—Ä–∞—Ç–∫–æ, –ø–æ –¥–µ–ª—É
- client_name –∏–∑–≤–ª–µ–∫–∏ –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è —á–∞—Ç–∞ –∏–ª–∏ –ø–µ—Ä–µ–ø–∏—Å–∫–∏"""

        result = self._call_gpt(system_prompt, conversation_text, max_tokens=400, temperature=0.3)

        if not result:
            return {}

        try:
            import json
            result = result.strip()
            if result.startswith("```"):
                result = result.split("```")[1]
                if result.startswith("json"):
                    result = result[4:]
            result = result.strip()

            data = json.loads(result)
            # –§–∏–ª—å—Ç—Ä—É–µ–º –ø—É—Å—Ç—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
            return {k: v for k, v in data.items() if v and v.strip()}
        except Exception as e:
            logger.error(f"Error parsing client info: {e}")
            return {}

    async def chat_with_assistant(
        self,
        user_message: str,
        user_name: str,
        available_clients: list[str] = None
    ) -> dict:
        """
        –û–±—â–µ–Ω–∏–µ —Å –∑–∞–±–æ—Ç—É—à–∫–æ–π –∫–∞–∫ —Å –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º.

        Returns:
            dict: {
                "type": "chat" | "stats" | "help" | "unknown",
                "response": str,  # –¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞
                "client_name": str | None,  # –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –ø—Ä–æ –∫–ª–∏–µ–Ω—Ç–∞
                "period": str | None  # –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –ø—Ä–æ –ø–µ—Ä–∏–æ–¥
            }
        """
        clients_list = ", ".join(available_clients[:20]) if available_clients else "–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö"

        system_prompt = f"""–¢—ã ‚Äî –ó–∞–±–æ—Ç—É—à–∫–∞, –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –±–æ—Ç-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è –ø—Ä–æ–¥–∂–µ–∫—Ç-–º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤–æ–≥–æ –∞–≥–µ–Ω—Ç—Å—Ç–≤–∞.
–¢—ã –¥–µ–≤—É—à–∫–∞, –≥–æ–≤–æ—Ä–∏—à—å –æ —Å–µ–±–µ –≤ –∂–µ–Ω—Å–∫–æ–º —Ä–æ–¥–µ. –¢—ã –∑–∞–±–æ—Ç–ª–∏–≤–∞—è, –≤–µ—Å—ë–ª–∞—è, –Ω–æ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è.

–¢–≤–æ–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —á–∞—Ç–æ–≤ —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏ –∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∏—Ç—å
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –¥–æ–≥–æ–≤–æ—Ä—ë–Ω–Ω–æ—Å—Ç–µ–π
- –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –ø–æ –∫–ª–∏–µ–Ω—Ç–∞–º (/client)
- –î–∞–π–¥–∂–µ—Å—Ç—ã –ø–µ—Ä–µ–ø–∏—Å–∫–∏ (/digest)
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —á–∞—Ç–∞–º
- –õ–∏—á–Ω—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
- –°–ø–∏—Å–æ–∫ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π (/reminders)
- –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á –≤ –ë–∏—Ç—Ä–∏–∫—Å24 (/task —Ç–µ–∫—Å—Ç –∑–∞–¥–∞—á–∏)
- –ü–ª–∞–Ω-—Ñ–∞–∫—Ç –æ—Ç—á—ë—Ç—ã (/plan)

–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {clients_list}

–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –æ–ø—Ä–µ–¥–µ–ª–∏, —á—Ç–æ —Ö–æ—á–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:

1. –ï—Å–ª–∏ —ç—Ç–æ –ü–†–ò–í–ï–¢–°–¢–í–ò–ï –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –æ–±—â–µ–Ω–∏–µ ‚Äî –ø–æ–∑–¥–æ—Ä–æ–≤–∞–π—Å—è —Ç–µ–ø–ª–æ, —Å–ø—Ä–æ—Å–∏ –∫–∞–∫ –¥–µ–ª–∞ –∏–ª–∏ —á–µ–º –ø–æ–º–æ—á—å.

2. –ï—Å–ª–∏ –ø—Ä–æ—Å—è—Ç –°–û–ó–î–ê–¢–¨ –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–ï ‚Äî –æ–ø—Ä–µ–¥–µ–ª–∏ —Ç–µ–∫—Å—Ç –∏ –≤—Ä–µ–º—è.
   –ü—Ä–∏–º–µ—Ä—ã: "–Ω–∞–ø–æ–º–Ω–∏ —á–µ—Ä–µ–∑ 2 —á–∞—Å–∞ –Ω–∞–ø–∏—Å–∞—Ç—å –∫–ª–∏–µ–Ω—Ç—É", "–Ω–∞–ø–æ–º–Ω–∏ –∑–∞–≤—Ç—Ä–∞ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç—á—ë—Ç", "—á–µ—Ä–µ–∑ —á–∞—Å –Ω–∞–ø–æ–º–Ω–∏ –ø–æ–∑–≤–æ–Ω–∏—Ç—å"
   –û–ø—Ä–µ–¥–µ–ª–∏ remind_in_hours: "—á–µ—Ä–µ–∑ —á–∞—Å" = 1, "—á–µ—Ä–µ–∑ 2 —á–∞—Å–∞" = 2, "–∑–∞–≤—Ç—Ä–∞" = 20, "—á–µ—Ä–µ–∑ 30 –º–∏–Ω—É—Ç" = 0.5

3. –ï—Å–ª–∏ –ø—Ä–æ—Å—è—Ç –°–¢–ê–¢–ò–°–¢–ò–ö–£ –∏–ª–∏ –î–ê–ô–î–ñ–ï–°–¢ –ø–æ –∫–ª–∏–µ–Ω—Ç—É ‚Äî –æ–ø—Ä–µ–¥–µ–ª–∏ –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞ –∏–∑ —Å–ø–∏—Å–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö.
   –ü—Ä–∏–º–µ—Ä—ã: "—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –í–∏–Ω–∫–æ—Ä–∞", "–¥–∞–π–¥–∂–µ—Å—Ç –ë–§–õ –∑–∞ –Ω–µ–¥–µ–ª—é", "—á—Ç–æ —Ç–∞–º —É –∫–ª–∏–µ–Ω—Ç–∞ X"

4. –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –ß–¢–û –¢–´ –£–ú–ï–ï–®–¨ –∏–ª–∏ –ü–û–ú–û–©–¨ ‚Äî –∫—Ä–∞—Ç–∫–æ —Ä–∞—Å—Å–∫–∞–∂–∏ –æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è—Ö.

5. –ï—Å–ª–∏ –ø—Ä–æ—Å—è—Ç –ü–û–ö–ê–ó–ê–¢–¨ –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–Ø ‚Äî —Å–∫–∞–∂–∏ –ø—Ä–æ –∫–æ–º–∞–Ω–¥—É /reminders

6. –ï—Å–ª–∏ –ø—Ä–æ—Å—è—Ç –°–û–ó–î–ê–¢–¨ –ó–ê–î–ê–ß–£ –í –ë–ò–¢–†–ò–ö–° ‚Äî —Å–∫–∞–∂–∏ –ø—Ä–æ –∫–æ–º–∞–Ω–¥—É /task
   –ü—Ä–∏–º–µ—Ä—ã: "—Å–æ–∑–¥–∞–π –∑–∞–¥–∞—á—É", "–¥–æ–±–∞–≤—å –∑–∞–¥–∞—á—É –≤ –±–∏—Ç—Ä–∏–∫—Å", "–ø–æ—Å—Ç–∞–≤—å –∑–∞–¥–∞—á—É"
   –û—Ç–≤–µ—Ç—å —á—Ç–æ –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—É /task —Ç–µ–∫—Å—Ç –∑–∞–¥–∞—á–∏

7. –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –ù–ï–ü–û–ù–Ø–¢–ï–ù ‚Äî –≤–µ–∂–ª–∏–≤–æ —É—Ç–æ—á–Ω–∏, —á–µ–º –ø–æ–º–æ—á—å.

–û—Ç–≤–µ—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON:
{{
  "type": "chat" | "stats" | "help" | "reminder" | "list_reminders" | "unknown",
  "response": "—Ç–≤–æ–π –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é",
  "client_name": "–Ω–∞–∑–≤–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ –µ—Å–ª–∏ –æ–ø—Ä–µ–¥–µ–ª–∏–ª–∞" –∏–ª–∏ null,
  "period": "–Ω–µ–¥–µ–ª—è" | "–º–µ—Å—è—Ü" | "–¥–µ–Ω—å" –∏–ª–∏ null,
  "reminder_text": "—Ç–µ–∫—Å—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è" –∏–ª–∏ null,
  "remind_in_hours": —á–∏—Å–ª–æ –∏–ª–∏ null
}}

–í–∞–∂–Ω–æ:
- –û—Ç–≤–µ—á–∞–π –∫–æ—Ä–æ—Ç–∫–æ –∏ –¥—Ä—É–∂–µ–ª—é–±–Ω–æ
- –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π —Å—Ç–∏–ª—å
- –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ —É–º–µ—Ä–µ–Ω–Ω–æ
- –ò–º—è –∫–ª–∏–µ–Ω—Ç–∞ –∏—â–∏ –ø–æ —á–∞—Å—Ç–∏—á–Ω–æ–º—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é –≤ —Å–ø–∏—Å–∫–µ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö
- –î–ª—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∑–∞–ø–æ–ª–Ω–∏ reminder_text –∏ remind_in_hours"""

        result = self._call_gpt(system_prompt, f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_name} –ø–∏—à–µ—Ç: {user_message}", max_tokens=300, temperature=0.7)

        if not result:
            return {
                "type": "chat",
                "response": "–û–π, —á—Ç–æ-—Ç–æ —è –∑–∞–¥—É–º–∞–ª–∞—Å—å ü§î –ü–æ–≤—Ç–æ—Ä–∏, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞?",
                "client_name": None,
                "period": None
            }

        try:
            import json
            result = result.strip()
            if result.startswith("```"):
                result = result.split("```")[1]
                if result.startswith("json"):
                    result = result[4:]
            result = result.strip()

            return json.loads(result)
        except Exception as e:
            logger.error(f"Error parsing assistant response: {e}, result: {result}")
            return {
                "type": "chat",
                "response": result[:500] if result else "–ù–µ —Å–æ–≤—Å–µ–º –ø–æ–Ω—è–ª–∞. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å? üí≠",
                "client_name": None,
                "period": None
            }


    async def generate_plan_fact(
        self,
        client_name: str,
        client_business: str | None,
        prev_month_name: str,
        prev_year: int,
        current_month_name: str,
        current_year: int,
        prev_messages: str,
        recent_messages: str
    ) -> str | None:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø–ª–∞–Ω-—Ñ–∞–∫—Ç –æ—Ç—á—ë—Ç –ø–æ –∫–ª–∏–µ–Ω—Ç—É.

        Returns:
            str: –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –ø–ª–∞–Ω-—Ñ–∞–∫—Ç–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
        """
        system_prompt = f"""–¢—ã ‚Äî –æ–ø—ã—Ç–Ω—ã–π –ø—Ä–æ–¥–∂–µ–∫—Ç-–º–µ–Ω–µ–¥–∂–µ—Ä –≤ digital-–∞–≥–µ–Ω—Ç—Å—Ç–≤–µ –ù–µ–π—Ä–æ–ü—Ä–æ–¥–∂–µ–∫—Ç. –°–æ—Å—Ç–∞–≤—å –ø–ª–∞–Ω-—Ñ–∞–∫—Ç –æ—Ç—á—ë—Ç –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞.

## TONE OF VOICE
–°—Ç–∏–ª—å: –∫–∞–∫ —Ä–∞–∑–≥–æ–≤–æ—Ä —Å —É–º–Ω—ã–º –¥—Ä—É–≥–æ–º, –∫–æ—Ç–æ—Ä—ã–π –∑–Ω–∞–µ—Ç, –∫–∞–∫ —Ä–µ—à–∏—Ç—å –∑–∞–¥–∞—á—É.
- –ü—Ä–æ—Å—Ç–æ –∏ –ø–æ –¥–µ–ª—É, –±–µ–∑ –∑–∞—É–º–Ω–æ—Å—Ç–µ–π
- –° —á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–º —Ç–æ–Ω–æ–º, –≤–æ–≤–ª–µ–∫–∞—é—â–µ
- –≠–∫—Å–ø–µ—Ä—Ç–Ω–æ, –Ω–æ –ª–µ–≥–∫–æ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–ª—É–±–∏–Ω—É, –Ω–æ –Ω–µ "—É–º–Ω–∏—á–∞–µ–º"
- –§–æ–∫—É—Å –Ω–∞ –±–∏–∑–Ω–µ—Å-—Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞

–ù–ï –ù–ê–î–û:
- –°—É—Ö–æ –∏ —Ñ–æ—Ä–º–∞–ª—å–Ω–æ ("–ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ–º —É—Å–ª—É–≥–∏...")
- –°–ª–æ–∂–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω—ã –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π
- –ü—É—Å—Ç—ã–µ –æ–±–µ—â–∞–Ω–∏—è –±–µ–∑ –æ—Å–Ω–æ–≤—ã

–ö–õ–ò–ï–ù–¢: {client_name}
–°–§–ï–†–ê –ë–ò–ó–ù–ï–°–ê: {client_business or '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'}
–ü–ï–†–ò–û–î –§–ê–ö–¢–ê: {prev_month_name} {prev_year}
–ü–ï–†–ò–û–î –ü–õ–ê–ù–ê: {current_month_name} {current_year}

## –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ (–∏—Å–ø–æ–ª—å–∑—É–π –ò–ú–ï–ù–ù–û —Ç–∞–∫–æ–π —Ñ–æ—Ä–º–∞—Ç):

üìä {client_name} ‚Äî {current_month_name} {current_year}

‚îÅ‚îÅ‚îÅ –ò–¢–û–ì–ò –ú–ï–°–Ø–¶–ê ‚îÅ‚îÅ‚îÅ

[–ö—Ä–∞—Ç–∫–∏–π –∏—Ç–æ–≥ 1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è]

üìà *–†–µ–∑—É–ª—å—Ç–∞—Ç—ã*
‚Ä¢ –†–µ–∑—É–ª—å—Ç–∞—Ç 1
‚Ä¢ –†–µ–∑—É–ª—å—Ç–∞—Ç 2

‚ö†Ô∏è *–°–ª–æ–∂–Ω–æ—Å—Ç–∏* (–µ—Å–ª–∏ –±—ã–ª–∏)
‚Ä¢ –ü—Ä–æ–±–ª–µ–º–∞ 1

‚îÅ‚îÅ‚îÅ –ü–õ–ê–ù –ù–ê –ú–ï–°–Ø–¶ ‚îÅ‚îÅ‚îÅ

üéØ *–¶–µ–ª—å:* [–≥–ª–∞–≤–Ω–∞—è —Ü–µ–ª—å –Ω–∞ –º–µ—Å—è—Ü]

üìã *–ö–ª—é—á–µ–≤—ã–µ –∑–∞–¥–∞—á–∏*
1. –ó–∞–¥–∞—á–∞ 1
   ‚Üí –ì–∏–ø–æ—Ç–µ–∑–∞ –ø–æ—á–µ–º—É –≤–∞–∂–Ω–æ
2. –ó–∞–¥–∞—á–∞ 2
3. –ó–∞–¥–∞—á–∞ 3

üìÖ *–ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ —Ç–æ—á–∫–∏*
‚Ä¢ –î–∞—Ç–∞ 1 ‚Äî —á—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏–º
‚Ä¢ –î–∞—Ç–∞ 2 ‚Äî —á—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏–º

‚îÅ‚îÅ‚îÅ –ù–£–ñ–ù–û –û–¢ –í–ê–° ‚îÅ‚îÅ‚îÅ

‚ùóÔ∏è –î–µ–π—Å—Ç–≤–∏–µ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞ 1
‚ùóÔ∏è –î–µ–π—Å—Ç–≤–∏–µ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞ 2

‚îÅ‚îÅ‚îÅ –í–ï–ö–¢–û–† –†–ê–ó–í–ò–¢–ò–Ø ‚îÅ‚îÅ‚îÅ

[2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –æ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –Ω–∞ –∫–≤–∞—Ä—Ç–∞–ª]

## –ü–†–ê–í–ò–õ–ê:
1. –ü–∏—à–∏ –ö–û–ù–ö–†–ï–¢–ù–û ‚Äî –Ω–µ "—É–ª—É—á—à–∏—Ç—å –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏", –∞ "—É–≤–µ–ª–∏—á–∏—Ç—å –∫–æ–Ω–≤–µ—Ä—Å–∏—é —Å 2% –¥–æ 3%"
2. –°–≤—è–∑—ã–≤–∞–π –∑–∞–¥–∞—á–∏ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ ‚Äî –∑–∞—á–µ–º –¥–µ–ª–∞–µ–º –∏ —á—Ç–æ –ø–æ–ª—É—á–∏–º
3. –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –º–∞–ª–æ ‚Äî —Ç–∞–∫ –∏ –ø–∏—à–∏ "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞"
4. –§–æ–∫—É—Å –Ω–∞ –±–∏–∑–Ω–µ—Å-—Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞
5. –°–µ–∫—Ü–∏—é "–ù—É–∂–Ω–æ –æ—Ç –≤–∞—Å" –≤–∫–ª—é—á–∞–π —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ä–µ–∞–ª—å–Ω–æ –Ω—É–∂–Ω—ã –¥–µ–π—Å—Ç–≤–∏—è –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞
6. –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º –Ω–µ –±—ã–ª–æ ‚Äî –Ω–µ –ø–∏—à–∏ —Å–µ–∫—Ü–∏—é "–°–ª–æ–∂–Ω–æ—Å—Ç–∏"
7. –ò—Å–ø–æ–ª—å–∑—É–π *–∑–≤—ë–∑–¥–æ—á–∫–∏* –¥–ª—è –∂–∏—Ä–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ (Markdown)"""

        user_content = f"""–ü–ï–†–ï–ü–ò–°–ö–ê –ó–ê –ü–†–û–®–õ–´–ô –ú–ï–°–Ø–¶:
{prev_messages}

–ü–û–°–õ–ï–î–ù–ò–ï –°–û–û–ë–©–ï–ù–ò–Ø (–∫–æ–Ω—Ç–µ–∫—Å—Ç):
{recent_messages}

–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –ø–ª–∞–Ω-—Ñ–∞–∫—Ç –æ—Ç—á—ë—Ç."""

        result = self._call_gpt(system_prompt, user_content, max_tokens=1500, temperature=0.6)

        if not result:
            return None

        return result


    async def generate_meeting_summary(
        self,
        transcript: str,
        meeting_context: str = ""
    ) -> dict:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–∞–º–º–∞—Ä–∏ –≤—Å—Ç—Ä–µ—á–∏ –ø–æ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏.

        Args:
            transcript: –¢–µ–∫—Å—Ç —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏
            meeting_context: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç (–Ω–∞–∑–≤–∞–Ω–∏–µ –≤—Å—Ç—Ä–µ—á–∏, —É—á–∞—Å—Ç–Ω–∏–∫–∏)

        Returns:
            dict: {
                "summary": str,  # –ö—Ä–∞—Ç–∫–æ–µ —Å–∞–º–º–∞—Ä–∏
                "key_points": list[str],  # –ö–ª—é—á–µ–≤—ã–µ —Ç–µ–∑–∏—Å—ã
                "decisions": list[str],  # –ü—Ä–∏–Ω—è—Ç—ã–µ —Ä–µ—à–µ–Ω–∏—è
                "tasks": list[dict],  # –ó–∞–¥–∞—á–∏ [{text, assignee, deadline}]
                "questions": list[str]  # –û—Ç–∫—Ä—ã—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã
            }
        """
        if not transcript:
            return {
                "summary": "–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –ø—É—Å—Ç–∞",
                "key_points": [],
                "decisions": [],
                "tasks": [],
                "questions": []
            }

        # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏
        max_chars = 30000  # ~7500 —Ç–æ–∫–µ–Ω–æ–≤
        if len(transcript) > max_chars:
            # –ë–µ—Ä—ë–º –Ω–∞—á–∞–ª–æ –∏ –∫–æ–Ω–µ—Ü
            half = max_chars // 2
            transcript = transcript[:half] + "\n\n[...—á–∞—Å—Ç—å —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ –ø—Ä–æ–ø—É—â–µ–Ω–∞...]\n\n" + transcript[-half:]

        context_part = f"\n–ö–æ–Ω—Ç–µ–∫—Å—Ç –≤—Å—Ç—Ä–µ—á–∏: {meeting_context}\n" if meeting_context else ""

        system_prompt = f"""–¢—ã ‚Äî –æ–ø—ã—Ç–Ω—ã–π –ø—Ä–æ–¥–∂–µ–∫—Ç-–º–µ–Ω–µ–¥–∂–µ—Ä. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é –≤—Å—Ç—Ä–µ—á–∏ –∏ —Å–æ—Å—Ç–∞–≤—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–∞–º–º–∞—Ä–∏.
{context_part}
## –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ (–°–¢–†–û–ì–û JSON):
{{
  "summary": "–ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ –≤—Å—Ç—Ä–µ—á–∏ –≤ 3-5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è—Ö",
  "key_points": [
    "–ö–ª—é—á–µ–≤–æ–π —Ç–µ–∑–∏—Å 1",
    "–ö–ª—é—á–µ–≤–æ–π —Ç–µ–∑–∏—Å 2"
  ],
  "decisions": [
    "–ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ 1",
    "–ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ 2"
  ],
  "tasks": [
    {{"text": "–¢–µ–∫—Å—Ç –∑–∞–¥–∞—á–∏", "assignee": "–ö—Ç–æ –¥–µ–ª–∞–µ—Ç –∏–ª–∏ null", "deadline": "–°—Ä–æ–∫ –∏–ª–∏ null"}},
    {{"text": "–ó–∞–¥–∞—á–∞ 2", "assignee": null, "deadline": "–¥–æ –ø—è—Ç–Ω–∏—Ü—ã"}}
  ],
  "questions": [
    "–û—Ç–∫—Ä—ã—Ç—ã–π –≤–æ–ø—Ä–æ—Å, –∫–æ—Ç–æ—Ä—ã–π –æ—Å—Ç–∞–ª—Å—è –±–µ–∑ –æ—Ç–≤–µ—Ç–∞"
  ]
}}

## –ü—Ä–∞–≤–∏–ª–∞:
1. –ü–∏—à–∏ –ö–û–ù–ö–†–ï–¢–ù–û ‚Äî –Ω–µ "–æ–±—Å—É–¥–∏–ª–∏ –ø—Ä–æ–µ–∫—Ç", –∞ "–æ–±—Å—É–¥–∏–ª–∏ –∑–∞–ø—É—Å–∫ —Ä–µ–∫–ª–∞–º—ã –≤ –Ø–Ω–¥–µ–∫—Å.–î–∏—Ä–µ–∫—Ç —Å –±—é–¥–∂–µ—Ç–æ–º 100–∫"
2. –ó–∞–¥–∞—á–∏ –≤—ã–¥–µ–ª—è–π –¢–û–õ–¨–ö–û –µ—Å–ª–∏ —è–≤–Ω–æ –∫—Ç–æ-—Ç–æ –≤–∑—è–ª –Ω–∞ —Å–µ–±—è –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ —á—Ç–æ-—Ç–æ —Å–¥–µ–ª–∞—Ç—å
3. –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –Ω–µ –Ω–∞–∑–≤–∞–Ω ‚Äî assignee = null
4. –ï—Å–ª–∏ —Å—Ä–æ–∫ –Ω–µ –Ω–∞–∑–≤–∞–Ω ‚Äî deadline = null
5. –í key_points –≤–∫–ª—é—á–∞–π —Ç–æ–ª—å–∫–æ –≤–∞–∂–Ω—ã–µ —Ç–µ–∑–∏—Å—ã, –Ω–µ –∫–∞–∂–¥—É—é —Ä–µ–ø–ª–∏–∫—É
6. decisions ‚Äî —Ç–æ–ª—å–∫–æ –Ø–í–ù–û –ø—Ä–∏–Ω—è—Ç—ã–µ —Ä–µ—à–µ–Ω–∏—è, –Ω–µ –ø—Ä–µ–¥–ø–æ–ª–æ–∂–µ–Ω–∏—è
7. questions ‚Äî –≤–æ–ø—Ä–æ—Å—ã, –∫–æ—Ç–æ—Ä—ã–µ –æ–±—Å—É–∂–¥–∞–ª–∏—Å—å, –Ω–æ –Ω–µ –±—ã–ª–∏ —Ä–µ—à–µ–Ω—ã
8. –ï—Å–ª–∏ –≤—Å—Ç—Ä–µ—á–∞ –Ω–∞ —Ä—É—Å—Å–∫–æ–º ‚Äî –ø–∏—à–∏ —Å–∞–º–º–∞—Ä–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º
9. –ù–µ –≤—ã–¥—É–º—ã–≤–∞–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –∫–æ—Ç–æ—Ä–æ–π –Ω–µ—Ç –≤ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏!"""

        result = self._call_gpt(
            system_prompt,
            f"–¢–†–ê–ù–°–ö–†–ò–ü–¶–ò–Ø –í–°–¢–†–ï–ß–ò:\n\n{transcript}",
            max_tokens=2000,
            temperature=0.3
        )

        if not result:
            return {
                "summary": "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤—Å—Ç—Ä–µ—á—É",
                "key_points": [],
                "decisions": [],
                "tasks": [],
                "questions": []
            }

        try:
            import json
            result = result.strip()
            if result.startswith("```"):
                result = result.split("```")[1]
                if result.startswith("json"):
                    result = result[4:]
            result = result.strip()

            data = json.loads(result)

            # –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è
            return {
                "summary": data.get("summary", ""),
                "key_points": data.get("key_points", []),
                "decisions": data.get("decisions", []),
                "tasks": data.get("tasks", []),
                "questions": data.get("questions", [])
            }
        except Exception as e:
            logger.error(f"Error parsing meeting summary: {e}, result: {result[:500]}")
            return {
                "summary": result[:1000] if result else "–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞",
                "key_points": [],
                "decisions": [],
                "tasks": [],
                "questions": []
            }


# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä
ai_service = OpenAIService()
